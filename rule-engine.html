<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¶ˆæ¯ç­–ç•¥ç®¡ç† - å‚¨èƒ½æŸœç®¡ç†ç³»ç»Ÿ</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        /* é¡µé¢å¸ƒå±€ */
        .main-content {
            height: calc(100vh - 60px);
            overflow-y: auto;
            padding: 20px;
        }

        /* é¡µé¢æ ‡é¢˜ */
        .page-header {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        /* åŠ¨ç”» */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: scale(1);
            }
            to {
                opacity: 0;
                transform: scale(0.9);
            }
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* å¼€å…³ç»„ä»¶æ ·å¼ */
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .switch-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: 0.3s;
            border-radius: 24px;
        }

        .switch-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .switch input:checked + .switch-slider {
            background-color: #3562E3;
        }

        .switch input:checked + .switch-slider:before {
            transform: translateX(20px);
        }

        [data-theme="dark"] .switch-slider {
            background-color: #4b5563;
        }

        [data-theme="dark"] .switch input:checked + .switch-slider {
            background-color: #3562E3;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            height: 40px;
            padding: 0 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            outline: none;
        }

        .btn-primary {
            background: #3562E3;
            color: white;
        }

        .btn-primary:hover {
            background: #2c51c9;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(53, 98, 227, 0.25);
        }

        .btn-secondary {
            background: white;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: #f3f4f6;
            color: var(--text-primary);
            border-color: var(--primary-color);
        }

        [data-theme="dark"] .btn-secondary {
            background: #334155;
            color: #e2e8f0;
            border-color: #475569;
        }

        [data-theme="dark"] .btn-secondary:hover {
            background: #475569;
            border-color: var(--primary-color);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .btn-search,
        .btn-reset {
            background: #EFEFEF;
            color: #333;
            border: none;
        }

        .btn-search:hover,
        .btn-reset:hover {
            background: #e0e0e0;
        }

        [data-theme="dark"] .btn-search,
        [data-theme="dark"] .btn-reset {
            background: #475569;
            color: #e2e8f0;
        }

        [data-theme="dark"] .btn-search:hover,
        [data-theme="dark"] .btn-reset:hover {
            background: #64748b;
        }

        /* é€šçŸ¥æ–¹å¼æ ·å¼ */
        .notification-item {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            font-size: 12px;
            color: var(--text-primary);
            background: #f3f4f6;
            border: 1px solid var(--border-color);
            border-radius: 16px;
            white-space: nowrap;
            margin-right: 6px;
            margin-bottom: 4px;
        }

        [data-theme="dark"] .notification-item {
            background: #334155;
            border-color: #475569;
        }

        /* è¾“å…¥æ¡†æ ·å¼ */
        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 13px;
            background: white;
            color: var(--text-primary);
            transition: all 0.2s;
        }

        [data-theme="dark"] .form-input,
        [data-theme="dark"] .form-select,
        [data-theme="dark"] .form-textarea {
            background: #0f172a;
            border-color: #334155;
            color: #e2e8f0;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #3562E3;
            box-shadow: 0 0 0 3px rgba(53, 98, 227, 0.1);
        }

        /* ========== ç¡®ä¿æ¨¡æ€æ¡†ä¸­çš„selectå¯äº¤äº’ ========== */
        .rule-modal-body select.form-select {
            position: relative;
            z-index: 1;
            cursor: pointer;
            pointer-events: auto !important;
        }

        .form-select:hover {
            border-color: #3562E3;
            background-color: #f8fafc;
        }

        [data-theme="dark"] .form-select:hover {
            background-color: #0f172a;
            border-color: #3562E3;
        }

        /* optgroupåˆ†ç»„æ ·å¼ä¼˜åŒ– */
        .form-select optgroup {
            font-weight: 600;
            color: #475569;
            padding: 8px 0;
            font-size: 13px;
            background: #f8fafc;
        }

        [data-theme="dark"] .form-select optgroup {
            color: #94a3b8;
            background: #0f172a;
        }

        .form-select option {
            padding: 8px 12px;
            color: var(--text-primary);
            font-size: 13px;
        }

        .form-select option:hover {
            background-color: #eff6ff;
        }

        [data-theme="dark"] .form-select option:hover {
            background-color: #1e3a5f;
        }

        /* ========== æœç´¢ç­›é€‰å¡ç‰‡æ ·å¼ ========== */
        .search-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        [data-theme="dark"] .search-section {
            background: #1e293b;
        }

        .search-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* åˆ—è¡¨å¤´éƒ¨æ ·å¼ */
        .list-header {
            margin-bottom: 20px;
        }

        /* ç­›é€‰å’Œæœç´¢æ ·å¼ */
        .filter-select {
            height: 40px;
            padding: 0 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            background: white;
            color: var(--text-primary);
            min-width: 180px;
            cursor: pointer;
        }

        [data-theme="dark"] .filter-select {
            background: #0f172a;
            border-color: #334155;
            color: #e2e8f0;
        }

        .filter-select:focus {
            outline: none;
            border-color: #3562E3;
            box-shadow: 0 0 0 3px rgba(53, 98, 227, 0.1);
        }

        .rule-search-wrapper {
            position: relative;
            flex: 1;
            max-width: 400px;
        }

        .rule-search-input {
            width: 100%;
            height: 40px;
            padding: 0 40px 0 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            background: white;
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        [data-theme="dark"] .rule-search-input {
            background: #0f172a;
            border-color: #334155;
            color: #e2e8f0;
        }

        .rule-search-input:focus {
            outline: none;
            border-color: #3562E3;
            box-shadow: 0 0 0 3px rgba(53, 98, 227, 0.1);
        }

        .rule-search-input::placeholder {
            color: var(--text-secondary);
        }

        .rule-search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            pointer-events: none;
        }

        /* ========== è§„åˆ™è¡¨æ ¼æ ·å¼ ========== */
        .content-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            padding: 24px;
        }

        [data-theme="dark"] .content-card {
            background: #1e293b;
        }

        .rules-table {
            width: 100%;
            border-collapse: collapse;
        }

        .rules-table thead {
            background: transparent;
        }

        .rules-table th {
            text-align: left;
            padding: 12px 8px;
            border-bottom: 2px solid var(--border-color);
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 13px;
            white-space: nowrap;
        }

        /* è¡¨æ ¼åˆ—å®½ä¼˜åŒ– */
        .rules-table th:nth-child(1) { width: 25%; min-width: 200px; } /* ç­–ç•¥åç§° */
        .rules-table th:nth-child(2) { width: 25%; min-width: 180px; } /* è§¦å‘æ¡ä»¶ */
        .rules-table th:nth-child(3) { width: 12%; min-width: 90px; }  /* é€šçŸ¥ç±»å‹ */
        .rules-table th:nth-child(4) { width: 10%; min-width: 80px; text-align: center; }  /* çŠ¶æ€ */
        .rules-table th:nth-child(5) { width: 15%; min-width: 140px; } /* åˆ›å»ºæ—¶é—´ */
        .rules-table th:nth-child(6) { width: 13%; min-width: 150px; text-align: center; } /* æ“ä½œ */

        [data-theme="dark"] .rules-table th {
            background: #0f172a;
            border-bottom-color: #334155;
        }

        .rules-table td {
            padding: 14px 8px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
            font-size: 13px;
            color: var(--text-primary);
        }

        /* é˜²æ­¢å†…å®¹æº¢å‡ºå’Œæ¢è¡Œ */
        .rules-table td:nth-child(2) { /* è§¦å‘æ¡ä»¶åˆ— */
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* çŠ¶æ€åˆ—å±…ä¸­ */
        .rules-table td:nth-child(4) {
            text-align: center;
        }

        [data-theme="dark"] .rules-table td {
            border-bottom-color: #334155;
        }

        .rules-table tbody tr {
            transition: background-color 0.2s ease;
        }

        .rules-table tbody tr:hover {
            background: #f9fafb;
        }

        [data-theme="dark"] .rules-table tbody tr:hover {
            background: #0f172a;
        }

        .rules-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* ç­–ç•¥åç§°åˆ—æ ·å¼ */
        .rule-name-cell {
            font-weight: 500;
            color: var(--text-primary);
        }

        .rule-name {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .rule-description {
            font-size: 12px;
            color: var(--text-secondary);
            max-width: 180px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* è§„åˆ™ç±»å‹å¾½ç«  */
        .rule-type-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
        }

        .rule-type-badge.system {
            background: #dbeafe;
            color: #1e40af;
        }

        .rule-type-badge.custom {
            background: #f3e8ff;
            color: #6b21a8;
        }

        [data-theme="dark"] .rule-type-badge.system {
            background: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
        }

        [data-theme="dark"] .rule-type-badge.custom {
            background: rgba(168, 85, 247, 0.2);
            color: #d8b4fe;
        }

        /* é€šçŸ¥ç±»å‹badge */
        .alarm-level-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
        }

        .alarm-level-badge.fault {
            background: #fee2e2;
            color: #dc2626;
        }

        .alarm-level-badge.warning {
            background: #fef3c7;
            color: #f59e0b;
        }

        .alarm-level-badge.notice {
            background: #dbeafe;
            color: #3b82f6;
        }

        [data-theme="dark"] .alarm-level-badge.fault {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        [data-theme="dark"] .alarm-level-badge.warning {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        [data-theme="dark"] .alarm-level-badge.notice {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        /* çŠ¶æ€badge */
        .rule-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
        }

        .rule-status-badge.active {
            background: #d1fae5;
            color: #065f46;
        }

        .rule-status-badge.inactive {
            background: #f3f4f6;
            color: #6b7280;
        }

        [data-theme="dark"] .rule-status-badge.active {
            background: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
        }

        [data-theme="dark"] .rule-status-badge.inactive {
            background: rgba(107, 114, 128, 0.2);
            color: #9ca3af;
        }

        .rule-status-badge i {
            font-size: 8px;
        }

        .badge-dot {
            font-size: 6px;
        }


        /* æ—¶é—´åˆ—æ ·å¼ */
        .rule-time-cell {
            color: var(--text-secondary);
            font-size: 13px;
        }

        /* ç©ºçŠ¶æ€ */
        .no-data-cell {
            text-align: center;
            padding: 60px 40px !important;
            color: var(--text-secondary);
        }

        .no-data-icon {
            font-size: 64px;
            display: block;
            margin-bottom: 20px;
            opacity: 0.3;
            color: var(--text-secondary);
        }

        .no-data-text {
            font-size: 16px;
            margin-bottom: 8px;
        }

        .no-data-subtext {
            font-size: 14px;
            opacity: 0.7;
        }

        /* ========== æ¨¡æ€æ¡†æ ·å¼ ========== */
        .rule-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            padding: 20px;
        }

        .rule-modal-overlay[style*="display: flex"] {
            display: flex !important;
        }

        .rule-modal-container {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            margin: auto;
        }

        [data-theme="dark"] .rule-modal-container {
            background: #1e293b;
        }

        .rule-modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(135deg, #3562E3 0%, #4f7aeb 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .rule-modal-title {
            margin: 0 0 8px 0;
            font-size: 24px;
            font-weight: 600;
        }

        .rule-modal-subtitle {
            margin: 0;
            opacity: 0.9;
            font-size: 14px;
        }

        .rule-modal-close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .rule-modal-close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .rule-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .rule-form-group {
            margin-bottom: 20px;
        }

        .rule-form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #475569;
            font-weight: 500;
        }

        [data-theme="dark"] .rule-form-label {
            color: #cbd5e1;
        }

        .rule-form-required {
            color: #ef4444;
        }

        .rule-modal-footer {
            padding: 20px 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background: #f8fafc;
        }

        [data-theme="dark"] .rule-modal-footer {
            background: #0f172a;
            border-top-color: #334155;
        }

        /* é™å™ªé…ç½®æš—é»‘æ¨¡å¼æ ·å¼ */
        [data-theme="dark"] .rule-form-group > div[style*="background: #f8fafc"] {
            background: #1e293b !important;
        }

        [data-theme="dark"] .rule-form-group input[type="time"],
        [data-theme="dark"] .rule-form-group input[type="date"] {
            background: #0f172a;
            border-color: #334155;
            color: #cbd5e1;
        }

        /* ä¸‹æ‹‰èœå•æ ·å¼ */
        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 8px;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            min-width: 150px;
            z-index: 1000;
            display: none;
        }

        [data-theme="dark"] .dropdown-menu {
            background: #1e293b;
            border-color: #334155;
        }

        .dropdown-menu.show {
            display: block;
            animation: fadeIn 0.2s ease;
        }

        .dropdown-item {
            padding: 10px 16px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-primary);
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dropdown-item:hover {
            background: #f3f4f6;
        }

        [data-theme="dark"] .dropdown-item:hover {
            background: #334155;
        }

        .dropdown-item:first-child {
            border-radius: 8px 8px 0 0;
        }

        .dropdown-item:last-child {
            border-radius: 0 0 8px 8px;
        }

        /* æ¨¡æ¿åˆ†ç±»æ ‡ç­¾é¡µæ ·å¼ */
        .template-tabs-wrapper {
            background: #f8fafc;
        }

        [data-theme="dark"] .template-tabs-wrapper {
            background: #0f172a;
        }

        .template-tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .template-tab:hover {
            color: var(--text-primary);
            background: rgba(53, 98, 227, 0.05);
        }

        .template-tab.active {
            color: #3562E3;
            border-bottom-color: #3562E3;
        }

        [data-theme="dark"] .template-tab {
            color: #94a3b8;
        }

        [data-theme="dark"] .template-tab:hover {
            color: #e2e8f0;
            background: rgba(53, 98, 227, 0.1);
        }

        [data-theme="dark"] .template-tab.active {
            color: #60a5fa;
            border-bottom-color: #60a5fa;
        }

        .template-category {
            animation: fadeIn 0.3s ease;
        }

        /* æš—é»‘ä¸»é¢˜æ”¯æŒ */
        [data-theme="dark"] .btn {
            background: #334155;
            border-color: #475569;
            color: #e2e8f0;
        }

        [data-theme="dark"] .btn:hover {
            background: #475569;
        }

        /* æŠ½å±‰æš—é»‘ä¸»é¢˜ */
        [data-theme="dark"] #deviceDrawer > div:last-child {
            background: #1e293b;
        }

        [data-theme="dark"] #deviceDrawer thead tr {
            border-bottom-color: #334155;
        }

        [data-theme="dark"] #deviceDrawer tbody tr {
            border-bottom-color: #334155;
        }

        [data-theme="dark"] #deviceSearchInput,
        [data-theme="dark"] #deviceSiteFilter {
            background: #0f172a;
            border-color: #334155;
            color: #e2e8f0;
        }

        [data-theme="dark"] #snFilter,
        [data-theme="dark"] #siteFilter {
            background: #0f172a;
            border-color: #334155;
            color: #e2e8f0;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1024px) {
            .rule-search-wrapper {
                width: 200px;
            }
        }

        @media (max-width: 768px) {
            .rules-toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            .rules-toolbar-right {
                justify-content: space-between;
            }

            .rule-search-wrapper {
                width: 100%;
            }

            .filter-select {
                width: 100%;
            }
        }

        /* ========== é€šçŸ¥è®¾ç½®é¢æ¿æ ·å¼ ========== */
        .notification-panel-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
        }

        .notification-panel-overlay.show {
            display: block;
        }

        .notification-panel {
            position: fixed;
            top: 0;
            right: -600px;
            bottom: 0;
            width: 600px;
            background: white;
            box-shadow: -4px 0 16px rgba(0, 0, 0, 0.2);
            z-index: 10001;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        [data-theme="dark"] .notification-panel {
            background: #1e293b;
        }

        .notification-panel.show {
            right: 0;
        }

        .notification-panel-header {
            padding: 18px 24px;
            border-bottom: 1px solid var(--border-color);
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-panel-title {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
            color: #1e293b;
        }

        .notification-panel-close {
            background: transparent;
            border: none;
            color: #64748b;
            width: 28px;
            height: 28px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .notification-panel-close:hover {
            background: #f1f5f9;
            color: #1e293b;
        }

        .notification-panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .notification-section {
            margin-bottom: 28px;
        }

        .notification-section-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .notification-checkbox-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .notification-checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
        }

        [data-theme="dark"] .notification-checkbox-item {
            background: #0f172a;
            border-color: #334155;
        }

        .notification-checkbox-item:hover {
            border-color: #3562E3;
            box-shadow: 0 1px 3px rgba(53, 98, 227, 0.1);
        }

        [data-theme="dark"] .notification-checkbox-item:hover {
            background: #1e293b;
            border-color: #3562E3;
        }

        .notification-checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #3562E3;
            flex-shrink: 0;
        }

        .notification-checkbox-item label {
            cursor: pointer;
            flex: 1;
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 400;
            white-space: nowrap;
        }

        .notification-checkbox-item i {
            font-size: 16px;
            flex-shrink: 0;
        }

        .noise-reduction-config {
            background: #f8fafc;
            border-radius: 8px;
            padding: 16px;
            border: 1px solid var(--border-color);
        }

        [data-theme="dark"] .noise-reduction-config {
            background: #0f172a;
            border-color: #334155;
        }

        .noise-reduction-item {
            margin-bottom: 16px;
        }

        .noise-reduction-item:last-child {
            margin-bottom: 0;
        }

        .noise-reduction-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .notification-panel-footer {
            padding: 12px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            background: white;
        }

        .notification-panel-footer .btn {
            height: 32px;
            padding: 0 20px;
            font-size: 13px;
            min-width: auto;
            width: auto;
            flex: 0 0 auto;
        }

        [data-theme="dark"] .notification-panel-header {
            background: #1e293b;
            border-bottom-color: #334155;
        }

        [data-theme="dark"] .notification-panel-title {
            color: #e2e8f0;
        }

        [data-theme="dark"] .notification-panel-close {
            color: #94a3b8;
        }

        [data-theme="dark"] .notification-panel-close:hover {
            background: #334155;
            color: #e2e8f0;
        }

        [data-theme="dark"] .notification-panel-footer {
            background: #1e293b;
            border-top-color: #334155;
        }

        /* é€šçŸ¥ç±»å‹å¡ç‰‡æš—è‰²ä¸»é¢˜ */
        [data-theme="dark"] .notification-section-title {
            color: #e2e8f0;
        }

        [data-theme="dark"] input[type="time"] {
            background: #0f172a;
            border-color: #334155;
            color: #e2e8f0;
        }

        /* ç­–ç•¥ç±»å‹å¡ç‰‡ç½‘æ ¼ */
        .policy-type-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 12px;
        }

        .policy-type-card {
            position: relative;
            padding: 20px;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .policy-type-card:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .policy-type-card.selected {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-color: #3b82f6;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
        }

        .policy-type-card.selected .policy-type-icon {
            font-size: 36px;
            transform: scale(1.1);
        }

        .policy-type-card.selected .policy-type-name {
            color: #ffffff;
            font-weight: 600;
        }

        .policy-type-card.selected .policy-type-desc {
            color: rgba(255, 255, 255, 0.9);
        }

        .policy-type-icon {
            font-size: 32px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .policy-type-name {
            font-size: 15px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 6px;
            transition: all 0.3s ease;
        }

        .policy-type-desc {
            font-size: 12px;
            color: #64748b;
            line-height: 1.4;
            transition: all 0.3s ease;
        }

        /* æš—è‰²ä¸»é¢˜ */
        [data-theme="dark"] .policy-type-card {
            background: #1e293b;
            border-color: #334155;
        }

        [data-theme="dark"] .policy-type-card:hover {
            background: #334155;
            border-color: #475569;
        }

        [data-theme="dark"] .policy-type-name {
            color: #e2e8f0;
        }

        [data-theme="dark"] .policy-type-desc {
            color: #94a3b8;
        }

        /* é€šçŸ¥æ–¹å¼å¤é€‰æ¡†æ ·å¼ */
        .notification-checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .notification-checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 8px;
            cursor: pointer;
            accent-color: #3b82f6;
        }

        .notification-checkbox-label input[type="checkbox"]:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .notification-checkbox-text {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: #1e293b;
            font-weight: 500;
        }

        [data-theme="dark"] .notification-checkbox-text {
            color: #e2e8f0;
        }

        /* ç»Ÿè®¡å¡ç‰‡æ ·å¼ */
        .stats-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
        }

        /* ç»Ÿè®¡å¡ç‰‡æš—è‰²ä¸»é¢˜ */
        [data-theme="dark"] .stats-card {
            background: #1e293b !important;
            border-color: #334155 !important;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3) !important;
        }

        [data-theme="dark"] .stats-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.5) !important;
        }
    </style>
</head>
<body data-page="rule-engine">
    <!-- å¯¼èˆªæ å®¹å™¨ç”± navbar.js è‡ªåŠ¨å¡«å…… -->

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <main class="main-content" id="mainContent">
        <div class="page-header">
            <h1 class="page-title" data-translate="alarmRuleManagement">æ¶ˆæ¯ç­–ç•¥ç®¡ç†</h1>
        </div>

        <!-- æ¶ˆæ¯é€šçŸ¥ç»Ÿè®¡ -->
        <div class="stats-section" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;">
            <!-- æ•…éšœæ¶ˆæ¯ç»Ÿè®¡ -->
            <div class="stats-card" style="background: #ffffff; border: 1px solid #e5e7eb; border-left: 3px solid #dc2626; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: all 0.3s;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="flex: 1;">
                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px; font-weight: 500;" data-translate="ruleStatsFault">æ•…éšœæ¶ˆæ¯ç­–ç•¥</div>
                        <div style="display: flex; align-items: baseline; gap: 4px; margin-bottom: 8px;">
                            <span id="faultCount" style="font-size: 32px; font-weight: 700; color: #1f2937; line-height: 1;">0</span>
                            <span style="font-size: 13px; color: #9ca3af;" data-translate="ruleStatsUnit">æ¡</span>
                        </div>
                        <div id="faultChannels" style="font-size: 11px; color: #9ca3af; line-height: 1.4;">
                            <span data-translate="ruleStatsTotalLabel">æ•…éšœæ€»ç­–ç•¥</span>:<span id="faultTotalCount">0</span> æ¡
                        </div>
                    </div>
                    <div style="width: 48px; height: 48px; background: #fef2f2; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-exclamation-circle" style="font-size: 24px; color: #dc2626;"></i>
                    </div>
                </div>
            </div>

            <!-- å‘Šè­¦æ¶ˆæ¯ç»Ÿè®¡ -->
            <div class="stats-card" style="background: #ffffff; border: 1px solid #e5e7eb; border-left: 3px solid #f59e0b; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: all 0.3s;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="flex: 1;">
                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px; font-weight: 500;" data-translate="ruleStatsWarning">å‘Šè­¦æ¶ˆæ¯ç­–ç•¥</div>
                        <div style="display: flex; align-items: baseline; gap: 4px; margin-bottom: 8px;">
                            <span id="warningCount" style="font-size: 32px; font-weight: 700; color: #1f2937; line-height: 1;">0</span>
                            <span style="font-size: 13px; color: #9ca3af;" data-translate="ruleStatsUnit">æ¡</span>
                        </div>
                        <div id="warningChannels" style="font-size: 11px; color: #9ca3af; line-height: 1.4;">
                            å‘Šè­¦æ€»ç­–ç•¥:<span id="warningTotalCount">0</span> æ¡
                        </div>
                    </div>
                    <div style="width: 48px; height: 48px; background: #fffbeb; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 24px; color: #f59e0b;"></i>
                    </div>
                </div>
            </div>

            <!-- é€šçŸ¥æ¶ˆæ¯ç»Ÿè®¡ -->
            <div class="stats-card" style="background: #ffffff; border: 1px solid #e5e7eb; border-left: 3px solid #3b82f6; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: all 0.3s;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="flex: 1;">
                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px; font-weight: 500;" data-translate="ruleStatsNotice">æ™®é€šæ¶ˆæ¯ç­–ç•¥</div>
                        <div style="display: flex; align-items: baseline; gap: 4px; margin-bottom: 8px;">
                            <span id="noticeCount" style="font-size: 32px; font-weight: 700; color: #1f2937; line-height: 1;">0</span>
                            <span style="font-size: 13px; color: #9ca3af;" data-translate="ruleStatsUnit">æ¡</span>
                        </div>
                        <div id="noticeChannels" style="font-size: 11px; color: #9ca3af; line-height: 1.4;">
                            é€šçŸ¥æ€»ç­–ç•¥:<span id="noticeTotalCount">0</span> æ¡
                        </div>
                    </div>
                    <div style="width: 48px; height: 48px; background: #eff6ff; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-info-circle" style="font-size: 24px; color: #3b82f6;"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- æœç´¢ç­›é€‰å¡ç‰‡ -->
        <div class="search-section">
            <div class="search-row">
                <div class="rule-search-wrapper">
                    <input
                        type="text"
                        class="rule-search-input"
                        id="ruleSearchInput"
                        placeholder="æœç´¢ç­–ç•¥åç§°..."
                        data-translate-placeholder="ruleSearchPlaceholder"
                    />
                    <i class="fas fa-search rule-search-icon"></i>
                </div>
                <select class="filter-select" id="ruleAlarmLevelFilter" onchange="filterRules()">
                    <option value="all" data-translate="ruleFilterAllTypes">å…¨éƒ¨é€šçŸ¥ç±»å‹</option>
                    <option value="fault" data-translate="ruleFilterFault">æ•…éšœ</option>
                    <option value="warning" data-translate="ruleFilterWarning">å‘Šè­¦</option>
                    <option value="notice" data-translate="ruleFilterNotice">é€šçŸ¥</option>
                </select>
                <select class="filter-select" id="ruleStatusFilter" onchange="filterRules()">
                    <option value="all" data-translate="ruleFilterAllStatus">å…¨éƒ¨çŠ¶æ€</option>
                    <option value="active" data-translate="ruleFilterActive">å·²å¯ç”¨</option>
                    <option value="inactive" data-translate="ruleFilterInactive">å·²ç¦ç”¨</option>
                </select>
                <div style="margin-left: auto; display: flex; gap: 12px;">
                    <button class="btn btn-search" onclick="searchRules(document.getElementById('ruleSearchInput').value)">
                        <i class="fas fa-search"></i>
                        <span data-translate="btnSearch">æŸ¥è¯¢</span>
                    </button>
                    <button class="btn btn-reset" onclick="refreshRuleList()">
                        <i class="fas fa-sync-alt"></i>
                        <span data-translate="ruleRefresh">é‡ç½®</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- è§„åˆ™åˆ—è¡¨å¡ç‰‡ -->
        <div class="content-card">
            <div class="list-header">
                <div style="display: flex; gap: 12px; align-items: center;">
                    <div style="position: relative; width: fit-content;">
                        <button class="btn btn-primary" onclick="toggleCreateMenu()" style="width: auto;">
                            <i class="fas fa-plus"></i>
                            <span data-translate="ruleNewRule">æ–°å»ºç­–ç•¥</span>
                            <i class="fas fa-chevron-down" style="font-size: 12px; margin-left: 4px;"></i>
                        </button>
                        <!-- ä¸‹æ‹‰èœå• -->
                        <div id="createMenu" class="dropdown-menu">
                            <div class="dropdown-item" onclick="createFromTemplate()">
                                <i class="fas fa-cube"></i>
                                <span data-translate="ruleFromTemplate">ä»æ¨¡ç‰ˆåˆ›å»º</span>
                            </div>
                            <div class="dropdown-item" onclick="createCustomRule()">
                                <i class="fas fa-magic"></i>
                                <span data-translate="ruleCustom">è‡ªå®šä¹‰ç­–ç•¥</span>
                            </div>
                        </div>
                    </div>
                    <!-- é€šçŸ¥è®¾ç½®æŒ‰é’® -->
                    <button class="btn btn-secondary" onclick="openNotificationPanel()" style="width: auto; display: none;">
                        <i class="fas fa-bell"></i>
                        <span>é€šçŸ¥è®¾ç½®</span>
                    </button>
                </div>
            </div>
            <table class="rules-table">
                <thead>
                    <tr>
                        <th data-translate="ruleColName">ç­–ç•¥åç§°</th>
                        <th data-translate="ruleColCondition">è§¦å‘æ¡ä»¶</th>
                        <th data-translate="ruleColAlarmLevel">é€šçŸ¥ç±»å‹</th>
                        <th data-translate="ruleColStatus">çŠ¶æ€</th>
                        <th data-translate="ruleColDeployedDevices">ä¸‹å‘è®¾å¤‡</th>
                        <th data-translate="ruleColCreateTime">åˆ›å»ºæ—¶é—´</th>
                        <th style="text-align: center;" data-translate="ruleColActions">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="rulesTableBody">
                    <!-- åŠ¨æ€å†…å®¹å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
                </tbody>
            </table>
        </div>
    </main>

    <!-- ç§»åŠ¨ç«¯é®ç½© -->
    <div id="mobileOverlay" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 998;" onclick="closeMobileSidebar()"></div>

    <!-- è§„åˆ™ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="ruleModal" class="rule-modal-overlay">
        <div class="rule-modal-container">
            <!-- æ¨¡æ€æ¡†å¤´éƒ¨ -->
            <div class="rule-modal-header">
                <div>
                    <h2 class="rule-modal-title" id="modalTitle" data-translate="ruleNewRule">æ–°å»ºç­–ç•¥</h2>
                    <p class="rule-modal-subtitle" id="modalSubtitle"></p>
                </div>
                <button class="rule-modal-close-btn" onclick="closeRuleModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- æ¨¡æ€æ¡†å†…å®¹ -->
            <div class="rule-modal-body">
                <form id="ruleForm">
                    <!-- ç­–ç•¥ç±»å‹ - ä¼˜å…ˆé€‰æ‹© -->
                    <div class="rule-form-group">
                        <label class="rule-form-label">
                            <span data-translate="ruleTypeLabel">ç­–ç•¥ç±»å‹</span>
                            <span class="rule-form-required">*</span>
                        </label>
                        <div class="policy-type-grid">
                            <div class="policy-type-card" onclick="selectPolicyType('fault')" data-type="fault">
                                <div class="policy-type-icon" style="color: #dc2626;">âš ï¸</div>
                                <div class="policy-type-name" data-translate="rulePolicyTypeFault">æ•…éšœ</div>
                                <div class="policy-type-desc" data-translate="rulePolicyTypeFaultDesc">éœ€è¦ç«‹å³ä¿®å¤</div>
                            </div>
                            <div class="policy-type-card" onclick="selectPolicyType('warning')" data-type="warning">
                                <div class="policy-type-icon" style="color: #f59e0b;">âš¡</div>
                                <div class="policy-type-name" data-translate="rulePolicyTypeWarning">å‘Šè­¦</div>
                                <div class="policy-type-desc" data-translate="rulePolicyTypeWarningDesc">éœ€è¦æŸ¥çœ‹å…³æ³¨</div>
                            </div>
                            <div class="policy-type-card" onclick="selectPolicyType('notice')" data-type="notice">
                                <div class="policy-type-icon" style="color: #3b82f6;">â„¹ï¸</div>
                                <div class="policy-type-name" data-translate="rulePolicyTypeNotice">é€šçŸ¥</div>
                                <div class="policy-type-desc" data-translate="rulePolicyTypeNoticeDesc">çŸ¥é“å°±è¡Œ</div>
                            </div>
                        </div>
                        <input type="hidden" id="ruleType" name="ruleType" value="">
                    </div>

                    <!-- åŸºæœ¬ä¿¡æ¯ - ä¸€æ’æ˜¾ç¤º -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                        <div class="rule-form-group" style="margin-bottom: 0;">
                            <label class="rule-form-label">
                                <span data-translate="ruleNameLabel">ç­–ç•¥åç§°</span>
                                <span class="rule-form-required">*</span>
                            </label>
                            <input type="text" class="form-input" id="ruleName" placeholder="è¯·è¾“å…¥ç­–ç•¥åç§°" data-translate-placeholder="ruleNamePlaceholder" required>
                        </div>

                        <div class="rule-form-group" style="margin-bottom: 0;">
                            <label class="rule-form-label" data-translate="ruleDescriptionLabel">ç­–ç•¥æè¿°</label>
                            <input type="text" class="form-input" id="ruleDescription" placeholder="è¯·è¾“å…¥ç­–ç•¥æè¿°" data-translate-placeholder="ruleDescPlaceholder">
                        </div>
                    </div>

                    <!-- è§¦å‘æ¡ä»¶ -->
                    <div class="rule-form-group">
                        <label class="rule-form-label">
                            <span data-translate="ruleTriggerCondition">è§¦å‘æ¡ä»¶</span>
                            <span class="rule-form-required">*</span>
                        </label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div>
                                <select class="form-select" id="ruleParameter">
                                    <option value="" data-translate="ruleSelectParameter">é€‰æ‹©ç›‘æµ‹å‚æ•°</option>
                                    <!-- ç”µæ± å‚æ•°ç»„ -->
                                    <optgroup label="ğŸ“Š ç”µæ± å‚æ•°" data-translate-label="groupBattery">
                                        <option value="soc" data-translate="paramSOC">SOCç”µé‡ (%)</option>
                                        <option value="soh" data-translate="paramSOH">SOHå¥åº·åº¦ (%)</option>
                                        <option value="voltage" data-translate="paramVoltage">æ€»ç”µå‹ (V)</option>
                                        <option value="current" data-translate="paramCurrent">æ€»ç”µæµ (A)</option>
                                        <option value="power" data-translate="paramPower">æ€»åŠŸç‡ (kW)</option>
                                        <option value="cell_voltage_max" data-translate="paramCellVoltageMax">å•ä½“æœ€é«˜ç”µå‹ (V)</option>
                                        <option value="cell_voltage_min" data-translate="paramCellVoltageMin">å•ä½“æœ€ä½ç”µå‹ (V)</option>
                                        <option value="cell_voltage_diff" data-translate="paramCellVoltageDiff">å•ä½“å‹å·® (V)</option>
                                    </optgroup>
                                    <!-- æ¸©åº¦å‚æ•°ç»„ -->
                                    <optgroup label="ğŸŒ¡ï¸ æ¸©åº¦å‚æ•°" data-translate-label="groupTemperature">
                                        <option value="temp_max" data-translate="paramTempMax">æœ€é«˜æ¸©åº¦ (â„ƒ)</option>
                                        <option value="temp_min" data-translate="paramTempMin">æœ€ä½æ¸©åº¦ (â„ƒ)</option>
                                        <option value="temp_diff" data-translate="paramTempDiff">æ¸©å·® (â„ƒ)</option>
                                        <option value="temp_avg" data-translate="paramTempAvg">å¹³å‡æ¸©åº¦ (â„ƒ)</option>
                                    </optgroup>
                                    <!-- ç³»ç»ŸçŠ¶æ€ç»„ -->
                                    <optgroup label="âš™ï¸ ç³»ç»ŸçŠ¶æ€" data-translate-label="groupSystem">
                                        <option value="charge_cycles" data-translate="paramChargeCycles">å……æ”¾ç”µæ¬¡æ•° (æ¬¡)</option>
                                        <option value="insulation_resistance" data-translate="paramInsulation">ç»ç¼˜é˜»å€¼ (kÎ©)</option>
                                        <option value="connection_status" data-translate="paramConnection">é€šä¿¡çŠ¶æ€</option>
                                    </optgroup>
                                    <!-- PCSå‚æ•°ç»„ -->
                                    <optgroup label="âš¡ PCSå‚æ•°" data-translate-label="groupPCS">
                                        <option value="grid_frequency" data-translate="paramGridFreq">ç”µç½‘é¢‘ç‡ (Hz)</option>
                                        <option value="ac_voltage" data-translate="paramACVoltage">äº¤æµç”µå‹ (V)</option>
                                        <option value="ac_current" data-translate="paramACCurrent">äº¤æµç”µæµ (A)</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div>
                                <select class="form-select" id="ruleOperator">
                                    <option value="" data-translate="ruleSelectCondition">é€‰æ‹©æ¡ä»¶</option>
                                    <option value="gt" data-translate="ruleOperatorGT">å¤§äº (&gt;)</option>
                                    <option value="lt" data-translate="ruleOperatorLT">å°äº (&lt;)</option>
                                    <option value="gte" data-translate="ruleOperatorGTE">å¤§äºç­‰äº (&gt;=)</option>
                                    <option value="lte" data-translate="ruleOperatorLTE">å°äºç­‰äº (&lt;=)</option>
                                    <option value="eq" data-translate="ruleOperatorEQ">ç­‰äº (=)</option>
                                </select>
                            </div>
                            <div>
                                <input type="number" class="form-input" id="ruleThreshold" placeholder="é˜ˆå€¼" data-translate-placeholder="ruleThresholdPlaceholder">
                            </div>
                            <div>
                                <input type="number" class="form-input" id="ruleDuration" placeholder="æŒç»­æ—¶é—´(åˆ†é’Ÿ)" data-translate-placeholder="ruleDurationPlaceholder">
                            </div>
                        </div>
                    </div>

                    <!-- é€šçŸ¥æ–¹å¼ -->
                    <div class="rule-form-group">
                        <label class="rule-form-label">
                            <span data-translate="ruleNotificationMethod">é€šçŸ¥æ–¹å¼</span>
                            <span class="rule-form-required">*</span>
                        </label>
                        <div style="display: flex; gap: 24px; flex-wrap: wrap; margin-top: 8px;">
                            <label class="notification-checkbox-label">
                                <input type="checkbox" id="notifyInApp" value="inapp" checked disabled>
                                <span class="notification-checkbox-text">
                                    <i class="fas fa-bell" style="margin-right: 6px; color: #3b82f6;"></i>
                                    <span data-translate="ruleNotifyInApp">ç«™å†…ä¿¡</span>
                                </span>
                            </label>
                            <label class="notification-checkbox-label">
                                <input type="checkbox" id="notifyEmail" value="email">
                                <span class="notification-checkbox-text">
                                    <i class="fas fa-envelope" style="margin-right: 6px; color: #10b981;"></i>
                                    <span data-translate="ruleNotifyEmail">é‚®ä»¶</span>
                                </span>
                            </label>
                            <label class="notification-checkbox-label">
                                <input type="checkbox" id="notifySms" value="sms">
                                <span class="notification-checkbox-text">
                                    <i class="fas fa-mobile-alt" style="margin-right: 6px; color: #f59e0b;"></i>
                                    <span data-translate="ruleNotifySms">çŸ­ä¿¡</span>
                                </span>
                            </label>
                        </div>
                    </div>

                    <!-- æ¶ˆæ¯é…ç½® -->
                    <div class="rule-form-group" style="border-top: 1px solid var(--border-color); padding-top: 20px; margin-top: 20px;">
                        <label class="rule-form-label" style="font-size: 16px; font-weight: 600; margin-bottom: 16px; display: block;">
                            <i class="fas fa-cog" style="margin-right: 8px; color: var(--primary-color);"></i>
                            <span data-translate="ruleAlarmConfig">æ¶ˆæ¯é…ç½®</span>
                        </label>

                        <!-- æ¶ˆæ¯å»é‡ -->
                        <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-copy" style="color: #3b82f6;"></i>
                                    <span style="font-weight: 500; font-size: 14px;" data-translate="ruleDeduplication">æ¶ˆæ¯å»é‡</span>
                                    <span style="color: var(--text-secondary); font-size: 12px;" data-translate="ruleDeduplicationHint">ï¼ˆé¿å…é‡å¤é€šçŸ¥ï¼‰</span>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="smartNoiseReductionEnabled">
                                    <span class="switch-slider"></span>
                                </label>
                            </div>
                            <div id="smartNoiseReductionConfig" style="display: none; padding-left: 28px;">
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; font-size: 13px; color: var(--text-secondary); margin-bottom: 6px;" data-translate="ruleTimeWindow">æ—¶é—´çª—å£</label>
                                    <select class="form-select" id="noiseReductionWindow" style="max-width: 300px;">
                                        <option value="5" data-translate="ruleTime5Min">5åˆ†é’Ÿ</option>
                                        <option value="10" selected data-translate="ruleTime10Min">10åˆ†é’Ÿ</option>
                                        <option value="30" data-translate="ruleTime30Min">30åˆ†é’Ÿ</option>
                                        <option value="60" data-translate="ruleTime1Hour">1å°æ—¶</option>
                                        <option value="120" data-translate="ruleTime2Hour">2å°æ—¶</option>
                                    </select>
                                </div>
                                <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 6px; padding: 12px; font-size: 13px; line-height: 1.6;">
                                    <div style="font-weight: 500; color: #1e40af; margin-bottom: 6px;">
                                        <i class="fas fa-info-circle" style="margin-right: 6px;"></i>
                                        <span data-translate="ruleInfoNote">è¯´æ˜</span>
                                    </div>
                                    <div style="color: #1e3a8a;" data-translate="ruleDeduplicationNote">
                                        åŒä¸€è®¾å¤‡çš„ç›¸åŒæ¶ˆæ¯åœ¨æ—¶é—´çª—å£å†…åªä¿ç•™ä¸€æ¡ï¼Œé¿å…é‡å¤é€šçŸ¥
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- è‡ªåŠ¨æ¶ˆé™¤ -->
                        <div style="background: #f8fafc; padding: 16px; border-radius: 8px;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-check-circle" style="color: #10b981;"></i>
                                    <span style="font-weight: 500; font-size: 14px;" data-translate="ruleAutoResolution">è‡ªåŠ¨æ¶ˆé™¤</span>
                                    <span style="color: var(--text-secondary); font-size: 12px;" data-translate="ruleAutoResolutionHint">ï¼ˆå‚æ•°æ¢å¤æ­£å¸¸åè‡ªåŠ¨è§£é™¤æ¶ˆæ¯ï¼‰</span>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="autoResolutionEnabled" checked>
                                    <span class="switch-slider"></span>
                                </label>
                            </div>
                            <div id="autoResolutionConfig" style="padding-left: 28px;">
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; font-size: 13px; color: var(--text-secondary); margin-bottom: 6px;" data-translate="ruleResolutionCondition">æ¶ˆé™¤æ¡ä»¶</label>
                                    <select class="form-select" id="autoResolutionCondition" style="max-width: 400px;">
                                        <option value="normal" selected data-translate="ruleResolutionNormal">å‚æ•°æ¢å¤æ­£å¸¸èŒƒå›´</option>
                                    </select>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;" data-translate="ruleResolutionConditionHint">
                                        ç¤ºä¾‹ï¼šæ¸©åº¦>60â„ƒæ¶ˆæ¯ â†’ æ¸©åº¦â‰¤60â„ƒè‡ªåŠ¨æ¶ˆé™¤
                                    </div>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 13px; color: var(--text-secondary); margin-bottom: 6px;" data-translate="ruleResolutionDelay">æ¶ˆé™¤å»¶è¿Ÿï¼ˆé˜²æŠ–ï¼‰</label>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <input type="number" class="form-input" id="autoResolutionDelay" placeholder="5" value="5" min="0" max="60" style="max-width: 100px;">
                                        <span style="font-size: 13px; color: var(--text-secondary);" data-translate="ruleUnitMinutes">åˆ†é’Ÿ</span>
                                    </div>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;" data-translate="ruleResolutionDelayHint">
                                        å‚æ•°æ¢å¤æ­£å¸¸å¹¶æŒç»­Nåˆ†é’Ÿåæ‰æ¶ˆé™¤ï¼Œé¿å…é¢‘ç¹æŠ–åŠ¨
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å¯ç”¨çŠ¶æ€ -->
                    <div class="rule-form-group">
                        <label class="rule-form-label" data-translate="ruleEnableStatus">å¯ç”¨çŠ¶æ€</label>
                        <label class="switch">
                            <input type="checkbox" id="ruleStatus" checked>
                            <span class="switch-slider"></span>
                        </label>
                    </div>
                </form>
            </div>

            <!-- æ¨¡æ€æ¡†åº•éƒ¨ -->
            <div class="rule-modal-footer">
                <button class="btn" onclick="closeRuleModal()" style="height: 40px; padding: 0 16px; background: transparent; border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 8px; cursor: pointer; transition: all 0.2s; white-space: nowrap;">
                    <span data-translate="btnCancel">å–æ¶ˆ</span>
                </button>
                <button class="btn btn-primary" onclick="saveRule()" style="height: 40px; padding: 0 16px; width: auto; display: inline-flex; align-items: center; gap: 6px; white-space: nowrap;">
                    <i class="fas fa-save"></i>
                    <span data-translate="btnSave">ä¿å­˜</span>
                </button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ è®¾å¤‡æ¨¡æ€æ¡† -->
    <div id="addDeviceModal" class="rule-modal-overlay">
        <div class="rule-modal-container" style="max-width: 800px;">
            <!-- å¤´éƒ¨ -->
            <div class="rule-modal-header">
                <div>
                    <h2 class="rule-modal-title" data-translate="ruleAddDevice">æ·»åŠ è®¾å¤‡</h2>
                    <p class="rule-modal-subtitle" data-translate="ruleAddDeviceSubtitle">é€‰æ‹©è¦ä¸‹å‘è§„åˆ™çš„è®¾å¤‡</p>
                </div>
                <button class="rule-modal-close-btn" onclick="closeAddDeviceModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- ä¸»ä½“å†…å®¹ -->
            <div class="rule-modal-body">
                <!-- é¡¶éƒ¨æœç´¢æ  -->
                <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                    <input
                        type="text"
                        id="deviceSearchInput"
                        placeholder="æœç´¢SN..."
                        data-translate-placeholder="ruleSearchSNPlaceholder"
                        style="flex: 1; height: 40px; padding: 0 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; background: white; color: var(--text-primary); transition: all 0.2s;"
                    />
                    <select id="deviceSiteFilter" style="flex: 1; height: 40px; padding: 0 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; background: white; color: var(--text-primary); cursor: pointer;">
                        <option value="" data-translate="ruleAllSites">å…¨éƒ¨ç«™ç‚¹</option>
                    </select>
                    <button class="btn btn-search" onclick="applyDeviceFilter()" style="height: 40px; padding: 0 20px; display: flex; align-items: center; justify-content: center; gap: 6px; border-radius: 20px;">
                        <i class="fas fa-search"></i>
                        <span data-translate="btnSearch">æŸ¥è¯¢</span>
                    </button>
                    <button class="btn btn-reset" onclick="resetDeviceFilter()" style="height: 40px; padding: 0 20px; display: flex; align-items: center; justify-content: center; gap: 6px; border-radius: 20px;">
                        <i class="fas fa-redo"></i>
                        <span data-translate="btnReset">é‡ç½®</span>
                    </button>
                </div>

                <!-- è®¾å¤‡è¡¨æ ¼ -->
                <div style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="position: sticky; top: 0; background: #f8fafc; z-index: 1;">
                            <tr style="border-bottom: 2px solid var(--border-color);">
                                <th style="width: 50px; text-align: center; padding: 12px 16px;">
                                    <input
                                        type="checkbox"
                                        id="selectAllNewDevices"
                                        onchange="toggleAllNewDevices(this.checked)"
                                        style="width: 18px; height: 18px; cursor: pointer;"
                                    />
                                </th>
                                <th style="text-align: left; padding: 12px 16px; font-weight: 600; color: var(--text-secondary); font-size: 13px; width: 35%;" data-translate="ruleColDeviceName">è®¾å¤‡åç§°</th>
                                <th style="text-align: left; padding: 12px 16px; font-weight: 600; color: var(--text-secondary); font-size: 13px; width: 25%;" data-translate="ruleColSN">SN</th>
                                <th style="text-align: left; padding: 12px 16px; font-weight: 600; color: var(--text-secondary); font-size: 13px; width: 25%;" data-translate="ruleColSite">ç«™ç‚¹</th>
                                <th style="text-align: center; padding: 12px 16px; font-weight: 600; color: var(--text-secondary); font-size: 13px; width: 15%;" data-translate="ruleColStatus">çŠ¶æ€</th>
                            </tr>
                        </thead>
                        <tbody id="availableDeviceList">
                            <!-- è®¾å¤‡è¡Œå°†åŠ¨æ€ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- åº•éƒ¨æ“ä½œåŒº -->
            <div class="rule-modal-footer" style="display: flex; justify-content: flex-end; gap: 12px;">
                <button
                    class="btn"
                    onclick="closeAddDeviceModal()"
                    style="width: 100px; height: 40px; padding: 0; background: transparent; border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 8px; cursor: pointer; transition: all 0.2s; white-space: nowrap;"
                >
                    <span data-translate="btnCancel">å–æ¶ˆ</span>
                </button>
                <button
                    class="btn btn-primary"
                    onclick="confirmAddDevices()"
                    style="width: 120px; height: 40px; padding: 0; display: inline-flex; align-items: center; justify-content: center; gap: 6px; white-space: nowrap;"
                >
                    <i class="fas fa-check"></i>
                    <span data-translate="ruleConfirmAdd">ç¡®è®¤æ·»åŠ </span>
                </button>
            </div>
        </div>
    </div>

    <!-- å·²ä¸‹å‘è®¾å¤‡æŠ½å±‰ -->
    <div id="deviceDrawer" style="display: none;">
        <!-- é®ç½©å±‚ -->
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 999;" onclick="closeDeviceDrawer()"></div>
        <!-- æŠ½å±‰å†…å®¹ -->
        <div style="position: fixed; top: 0; right: -450px; bottom: 0; width: 450px; background: white; box-shadow: -2px 0 8px rgba(0,0,0,0.1); z-index: 1000; transition: right 0.3s ease;">
            <div style="padding: 24px; height: 100%; display: flex; flex-direction: column;">
                <!-- æŠ½å±‰æ ‡é¢˜ -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <h3 id="drawerTitle" style="margin: 0 0 8px 0; font-size: 18px; font-weight: 600; color: var(--text-primary);" data-translate="ruleDeployedDevices">å·²ä¸‹å‘è®¾å¤‡</h3>
                        <p id="drawerSubtitle" style="margin: 0; font-size: 13px; color: var(--text-secondary);"></p>
                    </div>
                    <button onclick="closeDeviceDrawer()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                </div>

                <!-- æœç´¢å’Œæ“ä½œæ  -->
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                        <input
                            type="text"
                            id="snFilter"
                            placeholder="æœç´¢è®¾å¤‡SN..."
                            data-translate-placeholder="ruleSearchSNPlaceholder"
                            style="flex: 1; height: 40px; padding: 0 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; background: white; color: var(--text-primary);"
                        />
                        <select id="siteFilter" style="flex: 1; height: 40px; padding: 0 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; background: white; color: var(--text-primary); cursor: pointer;">
                            <option value="" data-translate="ruleAllSites">å…¨éƒ¨ç«™ç‚¹</option>
                        </select>
                        <button class="btn btn-search" onclick="filterDeployedDevices()" style="height: 40px; padding: 0 20px; display: flex; align-items: center; justify-content: center; gap: 6px; border-radius: 20px;">
                            <i class="fas fa-search"></i>
                            <span data-translate="btnSearch">æŸ¥è¯¢</span>
                        </button>
                    </div>
                    <button class="btn btn-primary" onclick="openAddDeviceModal()" style="width: 100px; height: 32px; padding: 0; display: inline-flex; align-items: center; justify-content: center; font-size: 12px;">
                        <span data-translate="ruleAddDevice">æ·»åŠ è®¾å¤‡</span>
                    </button>
                    <button class="btn" onclick="batchRemoveDevices()" style="width: 100px; height: 32px; padding: 0; display: inline-flex; align-items: center; justify-content: center; font-size: 12px; margin-left: 8px; background: #ef4444; color: white;">
                        <span data-translate="ruleBatchRemove">æ‰¹é‡ç§»é™¤</span>
                    </button>
                </div>

                <!-- è®¾å¤‡åˆ—è¡¨ -->
                <div style="flex: 1; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid var(--border-color);">
                                <th style="text-align: center; padding: 12px 8px; font-weight: 600; color: var(--text-secondary); font-size: 13px; width: 50px;">
                                    <input type="checkbox" id="selectAllDeployedDevices" onchange="toggleAllDeployedDevices(this.checked)" style="cursor: pointer;">
                                </th>
                                <th style="text-align: left; padding: 12px 8px; font-weight: 600; color: var(--text-secondary); font-size: 13px;" data-translate="ruleColDeviceSN">è®¾å¤‡SN</th>
                                <th style="text-align: left; padding: 12px 8px; font-weight: 600; color: var(--text-secondary); font-size: 13px;" data-translate="ruleColSite">ç«™ç‚¹</th>
                                <th style="text-align: center; padding: 12px 8px; font-weight: 600; color: var(--text-secondary); font-size: 13px; width: 80px;" data-translate="ruleColOperation">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="deployedDeviceList">
                            <!-- å·²ä¸‹å‘è®¾å¤‡å°†åŠ¨æ€ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>

                <!-- åº•éƒ¨ç¡®è®¤æŒ‰é’® -->
                <div style="padding: 20px 0 0 0; display: flex; justify-content: flex-end;">
                    <button class="btn btn-primary" onclick="closeDeviceDrawer()" style="width: 100px; height: 40px; padding: 0; display: inline-flex; align-items: center; justify-content: center;">
                        <span data-translate="btnConfirm">ç¡®è®¤</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¨¡ç‰ˆé€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="templateModal" class="rule-modal-overlay">
        <div class="rule-modal-container">
            <div class="rule-modal-header">
                <div>
                    <h2 class="rule-modal-title" data-translate="ruleSelectTemplate">é€‰æ‹©è§„åˆ™æ¨¡ç‰ˆ</h2>
                    <p class="rule-modal-subtitle" data-translate="ruleSelectTemplateSubtitle">é€‰æ‹©ä¸€ä¸ªç³»ç»Ÿæ¨¡ç‰ˆä½œä¸ºèµ·ç‚¹</p>
                </div>
                <button class="rule-modal-close-btn" onclick="closeTemplateModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <!-- åˆ†ç±»æ ‡ç­¾é¡µ -->
            <div class="template-tabs-wrapper" style="border-bottom: 1px solid var(--border-color); padding: 0 24px;">
                <div style="display: flex; gap: 8px;">
                    <button class="template-tab active" onclick="switchTemplateTab('inverter')" data-tab="inverter">
                        <i class="fas fa-plug"></i>
                        <span data-translate="ruleTabInverter">é€†å˜å™¨</span>
                    </button>
                    <button class="template-tab" onclick="switchTemplateTab('battery')" data-tab="battery">
                        <i class="fas fa-battery-three-quarters"></i>
                        <span data-translate="ruleTabBattery">ç”µæ± </span>
                    </button>
                    <button class="template-tab" onclick="switchTemplateTab('meter')" data-tab="meter">
                        <i class="fas fa-tachometer-alt"></i>
                        <span data-translate="ruleTabMeter">ç”µè¡¨</span>
                    </button>
                    <button class="template-tab" onclick="switchTemplateTab('temperature')" data-tab="temperature">
                        <i class="fas fa-thermometer-half"></i>
                        <span data-translate="ruleTabTemperature">æ¸©åº¦</span>
                    </button>
                    <button class="template-tab" onclick="switchTemplateTab('fire')" data-tab="fire">
                        <i class="fas fa-fire-extinguisher"></i>
                        <span data-translate="ruleTabFire">æ¶ˆé˜²</span>
                    </button>
                </div>
            </div>
            <div class="rule-modal-body">
                <!-- é€†å˜å™¨æ¨¡ç‰ˆ -->
                <div class="template-category" id="inverter-templates" style="display: grid; grid-template-columns: 1fr; gap: 16px;">
                    <div style="border: 2px solid var(--border-color); border-radius: 8px; padding: 16px; cursor: pointer; transition: all 0.2s;" onclick="selectTemplate('inverterOverload')">
                        <div style="font-weight: 600; margin-bottom: 8px;" data-translate="ruleName_inverterOverload">é€†å˜å™¨è¿‡è½½å‘Šè­¦</div>
                        <div style="font-size: 13px; color: var(--text-secondary);" data-translate="ruleDesc_inverterOverload">åŠŸç‡è¶…è¿‡é¢å®šåŠŸç‡110%</div>
                    </div>
                    <div style="border: 2px solid var(--border-color); border-radius: 8px; padding: 16px; cursor: pointer; transition: all 0.2s;" onclick="selectTemplate('inverterFault')">
                        <div style="font-weight: 600; margin-bottom: 8px;" data-translate="ruleName_inverterFault">é€†å˜å™¨æ•…éšœå‘Šè­¦</div>
                        <div style="font-size: 13px; color: var(--text-secondary);" data-translate="ruleDesc_inverterFault">é€†å˜å™¨å·¥ä½œå¼‚å¸¸</div>
                    </div>
                    <div style="border: 2px solid var(--border-color); border-radius: 8px; padding: 16px; cursor: pointer; transition: all 0.2s;" onclick="selectTemplate('inverterTemp')">
                        <div style="font-weight: 600; margin-bottom: 8px;" data-translate="ruleName_inverterTemp">é€†å˜å™¨æ¸©åº¦å‘Šè­¦</div>
                        <div style="font-size: 13px; color: var(--text-secondary);" data-translate="ruleDesc_inverterTemp">é€†å˜å™¨æ¸©åº¦è¿‡é«˜</div>
                    </div>
                </div>

                <!-- ç”µæ± æ¨¡ç‰ˆ -->
                <div class="template-category" id="battery-templates" style="display: none; grid-template-columns: 1fr; gap: 16px;">
                    <div style="border: 2px solid var(--border-color); border-radius: 8px; padding: 16px; cursor: pointer; transition: all 0.2s;" onclick="selectTemplate('batteryHighTemp')">
                        <div style="font-weight: 600; margin-bottom: 8px;" data-translate="ruleName_batteryHighTemp">ç”µæ± é«˜æ¸©å‘Šè­¦</div>
                        <div style="font-size: 13px; color: var(--text-secondary);" data-translate="ruleDesc_batteryHighTemp">æ¸©åº¦è¶…è¿‡55Â°Cæ—¶è§¦å‘å‘Šè­¦</div>
                    </div>
                    <div style="border: 2px solid var(--border-color); border-radius: 8px; padding: 16px; cursor: pointer; transition: all 0.2s;" onclick="selectTemplate('batteryLowSOC')">
                        <div style="font-weight: 600; margin-bottom: 8px;" data-translate="ruleName_batteryLowSOC">ç”µæ± SOCä½å‘Šè­¦</div>
                        <div style="font-size: 13px; color: var(--text-secondary);" data-translate="ruleDesc_batteryLowSOC">SOCä½äº20%æ—¶è§¦å‘å‘Šè­¦</div>
                    </div>
                    <div style="border: 2px solid var(--border-color); border-radius: 8px; padding: 16px; cursor: pointer; transition: all 0.2s;" onclick="selectTemplate('batteryVoltageDiff')">
                        <div style="font-weight: 600; margin-bottom: 8px;" data-translate="ruleName_batteryVoltageDiff">ç”µæ± å‹å·®å‘Šè­¦</div>
                        <div style="font-size: 13px; color: var(--text-secondary);" data-translate="ruleDesc_batteryVoltageDiff">å•ä½“ç”µå‹å·®è¶…è¿‡0.3V</div>
                    </div>
                    <div style="border: 2px solid var(--border-color); border-radius: 8px; padding: 16px; cursor: pointer; transition: all 0.2s;" onclick="selectTemplate('batteryOverCurrent')">
                        <div style="font-weight: 600; margin-bottom: 8px;" data-translate="ruleName_batteryOverCurrent">ç”µæ± è¿‡æµå‘Šè­¦</div>
                        <div style="font-size: 13px; color: var(--text-secondary);" data-translate="ruleDesc_batteryOverCurrent">å……æ”¾ç”µæµè¶…è¿‡é¢å®šå€¼</div>
                    </div>
                </div>

                <!-- ç”µè¡¨æ¨¡ç‰ˆ -->
                <div class="template-category" id="meter-templates" style="display: none; grid-template-columns: 1fr; gap: 16px;">
                    <div style="border: 2px solid var(--border-color); border-radius: 8px; padding: 16px; cursor: pointer; transition: all 0.2s;" onclick="selectTemplate('energyAbnormal')">
                        <div style="font-weight: 600; margin-bottom: 8px;" data-translate="ruleName_energyAbnormal">èƒ½æºå¼‚å¸¸å‘Šè­¦</div>
                        <div style="font-size: 13px; color: var(--text-secondary);" data-translate="ruleDesc_energyAbnormal">èƒ½æºæ¶ˆè€—å¼‚å¸¸æ³¢åŠ¨</div>
                    </div>
                    <div style="border: 2px solid var(--border-color); border-radius: 8px; padding: 16px; cursor: pointer; transition: all 0.2s;" onclick="selectTemplate('powerOverload')">
                        <div style="font-weight: 600; margin-bottom: 8px;" data-translate="ruleName_powerOverload">åŠŸç‡è¶…æ ‡å‘Šè­¦</div>
                        <div style="font-size: 13px; color: var(--text-secondary);" data-translate="ruleDesc_powerOverload">æ€»åŠŸç‡è¶…è¿‡è®¾å®šå€¼</div>
                    </div>
                    <div style="border: 2px solid var(--border-color); border-radius: 8px; padding: 16px; cursor: pointer; transition: all 0.2s;" onclick="selectTemplate('voltageAbnormal')">
                        <div style="font-weight: 600; margin-bottom: 8px;" data-translate="ruleName_voltageAbnormal">ç”µå‹å¼‚å¸¸å‘Šè­¦</div>
                        <div style="font-size: 13px; color: var(--text-secondary);" data-translate="ruleDesc_voltageAbnormal">ç”µç½‘ç”µå‹è¶…å‡ºæ­£å¸¸èŒƒå›´</div>
                    </div>
                    <div style="border: 2px solid var(--border-color); border-radius: 8px; padding: 16px; cursor: pointer; transition: all 0.2s;" onclick="selectTemplate('currentAbnormal')">
                        <div style="font-weight: 600; margin-bottom: 8px;" data-translate="ruleName_currentAbnormal">ç”µæµå¼‚å¸¸å‘Šè­¦</div>
                        <div style="font-size: 13px; color: var(--text-secondary);" data-translate="ruleDesc_currentAbnormal">ç”µæµè¶…è¿‡é¢å®šå€¼</div>
                    </div>
                </div>

                <!-- æ¸©åº¦æ¨¡ç‰ˆ -->
                <div class="template-category" id="temperature-templates" style="display: none; grid-template-columns: 1fr; gap: 16px;">
                    <div style="border: 2px solid var(--border-color); border-radius: 8px; padding: 16px; cursor: pointer; transition: all 0.2s;" onclick="selectTemplate('envTempHigh')">
                        <div style="font-weight: 600; margin-bottom: 8px;" data-translate="ruleName_envTempHigh">ç¯å¢ƒé«˜æ¸©å‘Šè­¦</div>
                        <div style="font-size: 13px; color: var(--text-secondary);" data-translate="ruleDesc_envTempHigh">ç¯å¢ƒæ¸©åº¦è¶…è¿‡35Â°C</div>
                    </div>
                    <div style="border: 2px solid var(--border-color); border-radius: 8px; padding: 16px; cursor: pointer; transition: all 0.2s;" onclick="selectTemplate('envTempLow')">
                        <div style="font-weight: 600; margin-bottom: 8px;" data-translate="ruleName_envTempLow">ç¯å¢ƒä½æ¸©å‘Šè­¦</div>
                        <div style="font-size: 13px; color: var(--text-secondary);" data-translate="ruleDesc_envTempLow">ç¯å¢ƒæ¸©åº¦ä½äº0Â°C</div>
                    </div>
                    <div style="border: 2px solid var(--border-color); border-radius: 8px; padding: 16px; cursor: pointer; transition: all 0.2s;" onclick="selectTemplate('humidityHigh')">
                        <div style="font-weight: 600; margin-bottom: 8px;" data-translate="ruleName_humidityHigh">é«˜æ¹¿åº¦å‘Šè­¦</div>
                        <div style="font-size: 13px; color: var(--text-secondary);" data-translate="ruleDesc_humidityHigh">æ¹¿åº¦è¶…è¿‡85%</div>
                    </div>
                    <div style="border: 2px solid var(--border-color); border-radius: 8px; padding: 16px; cursor: pointer; transition: all 0.2s;" onclick="selectTemplate('deviceTempHigh')">
                        <div style="font-weight: 600; margin-bottom: 8px;" data-translate="ruleName_deviceTempHigh">è®¾å¤‡æ¸©åº¦å‘Šè­¦</div>
                        <div style="font-size: 13px; color: var(--text-secondary);" data-translate="ruleDesc_deviceTempHigh">è®¾å¤‡è¡¨é¢æ¸©åº¦è¿‡é«˜</div>
                    </div>
                </div>

                <!-- æ¶ˆé˜²æ¨¡ç‰ˆ -->
                <div class="template-category" id="fire-templates" style="display: none; grid-template-columns: 1fr; gap: 16px;">
                    <div style="border: 2px solid var(--border-color); border-radius: 8px; padding: 16px; cursor: pointer; transition: all 0.2s;" onclick="selectTemplate('smokeAlarm')">
                        <div style="font-weight: 600; margin-bottom: 8px;" data-translate="ruleName_smokeAlarm">çƒŸé›¾å‘Šè­¦</div>
                        <div style="font-size: 13px; color: var(--text-secondary);" data-translate="ruleDesc_smokeAlarm">æ£€æµ‹åˆ°çƒŸé›¾ä¿¡å·</div>
                    </div>
                    <div style="border: 2px solid var(--border-color); border-radius: 8px; padding: 16px; cursor: pointer; transition: all 0.2s;" onclick="selectTemplate('fireAlarm')">
                        <div style="font-weight: 600; margin-bottom: 8px;" data-translate="ruleName_fireAlarm">ç«ç¾å‘Šè­¦</div>
                        <div style="font-size: 13px; color: var(--text-secondary);" data-translate="ruleDesc_fireAlarm">æ£€æµ‹åˆ°ç«ç¾ä¿¡å·</div>
                    </div>
                    <div style="border: 2px solid var(--border-color); border-radius: 8px; padding: 16px; cursor: pointer; transition: all 0.2s;" onclick="selectTemplate('waterLeakage')">
                        <div style="font-weight: 600; margin-bottom: 8px;" data-translate="ruleName_waterLeakage">æ¼æ°´å‘Šè­¦</div>
                        <div style="font-size: 13px; color: var(--text-secondary);" data-translate="ruleDesc_waterLeakage">æ£€æµ‹åˆ°æ¼æ°´ä¿¡å·</div>
                    </div>
                    <div style="border: 2px solid var(--border-color); border-radius: 8px; padding: 16px; cursor: pointer; transition: all 0.2s;" onclick="selectTemplate('gasLeakage')">
                        <div style="font-weight: 600; margin-bottom: 8px;" data-translate="ruleName_gasLeakage">æ°”ä½“æ³„æ¼å‘Šè­¦</div>
                        <div style="font-size: 13px; color: var(--text-secondary);" data-translate="ruleDesc_gasLeakage">æ£€æµ‹åˆ°å¯ç‡ƒæ°”ä½“æ³„æ¼</div>
                    </div>
                </div>
            </div>
            <div class="rule-modal-footer">
                <button class="btn btn-secondary" onclick="closeTemplateModal()">
                    <span data-translate="btnCancel">å–æ¶ˆ</span>
                </button>
            </div>
        </div>
    </div>

    <!-- é€šçŸ¥è®¾ç½®é¢æ¿ -->
    <div id="notificationPanelOverlay" class="notification-panel-overlay" onclick="closeNotificationPanel()"></div>
    <div id="notificationPanel" class="notification-panel">
        <!-- é¢æ¿å¤´éƒ¨ -->
        <div class="notification-panel-header">
            <h2 class="notification-panel-title">
                <i class="fas fa-bell" style="margin-right: 8px;"></i>
                <span data-translate="notificationPanelTitle">å‘Šè­¦é€šçŸ¥ç­–ç•¥</span>
            </h2>
            <button class="notification-panel-close" onclick="closeNotificationPanel()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- é¢æ¿ä¸»ä½“ -->
        <div class="notification-panel-body">
            <!-- é€šçŸ¥ç±»å‹é…ç½® -->
            <div class="notification-section">
                <div class="notification-section-title">
                    <i class="fas fa-layer-group" style="color: #64748b;"></i>
                    <span data-translate="notificationTypeSettings">é€šçŸ¥ç±»å‹è®¾ç½®</span>
                </div>

                <!-- æ•…éšœ -->
                <div style="margin-bottom: 20px;">
                    <!-- é€šçŸ¥ç±»å‹æ ‡é¢˜ -->
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; cursor: pointer;" onclick="toggleAlarmLevel('fault')">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-chevron-down" id="faultChevron" style="color: #64748b; font-size: 12px; transition: transform 0.3s; transform: rotate(-90deg);"></i>
                            <i class="fas fa-exclamation-circle" style="color: #dc2626; font-size: 16px;"></i>
                            <span style="font-weight: 600; font-size: 14px; color: #1e293b;" data-translate="notificationFault">æ•…éšœ</span>
                            <span style="font-size: 12px; color: #64748b; margin-left: 4px;" data-translate="notificationFaultDesc">éœ€è¦ç«‹å³ä¿®å¤</span>
                        </div>
                        <label class="switch" onclick="event.stopPropagation()">
                            <input type="checkbox" id="faultEnabled" checked>
                            <span class="switch-slider"></span>
                        </label>
                    </div>

                    <!-- é…ç½®å¡ç‰‡ -->
                    <div id="faultContent" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 0; transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease, border-width 0.3s ease; max-height: 0; opacity: 0; overflow: hidden; border-width: 0;">
                        <!-- é€šçŸ¥æ–¹å¼ -->
                        <div style="margin-bottom: 16px;">
                            <div style="font-size: 13px; color: #64748b; margin-bottom: 8px;" data-translate="notificationMethod">é€šçŸ¥æ–¹å¼</div>
                            <div class="notification-checkbox-group">
                                <div class="notification-checkbox-item">
                                    <input type="checkbox" id="faultSms" checked>
                                    <i class="fas fa-sms" style="color: #64748b;"></i>
                                    <label for="faultSms" data-translate="notificationSms">çŸ­ä¿¡</label>
                                </div>
                                <div class="notification-checkbox-item">
                                    <input type="checkbox" id="faultEmail" checked>
                                    <i class="fas fa-envelope" style="color: #64748b;"></i>
                                    <label for="faultEmail" data-translate="notificationEmail">é‚®ä»¶</label>
                                </div>
                            </div>
                        </div>

                        <!-- æ¶ˆæ¯é™å™ª -->
                        <div style="padding-top: 16px; border-top: 1px solid #e2e8f0;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <i class="fas fa-volume-mute" style="color: #64748b; font-size: 13px;"></i>
                                    <span style="font-size: 13px; color: #64748b;" data-translate="notificationNoise">æ¶ˆæ¯é™å™ª</span>
                                </div>
                                <label class="switch" style="transform: scale(0.85);">
                                    <input type="checkbox" id="faultNoiseEnabled" checked onchange="toggleNoiseConfig('fault', this.checked)">
                                    <span class="switch-slider"></span>
                                </label>
                            </div>
                            <div id="faultNoiseConfig" style="display: block; transition: max-height 0.3s ease, opacity 0.3s ease; overflow: hidden; max-height: 100px; opacity: 1;">
                                <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap; font-size: 13px; color: #64748b;">
                                    <input type="number" class="form-input" id="faultRepeatInterval" value="30" min="1" max="120" style="width: 60px; text-align: center; height: 32px; font-size: 13px;">
                                    <span data-translate="notificationNoiseDesc">åˆ†é’Ÿå†…æœ€å¤šå‘é€</span>
                                    <input type="number" class="form-input" id="faultMaxRepeats" value="3" min="1" max="20" style="width: 50px; text-align: center; height: 32px; font-size: 13px;">
                                    <span data-translate="notificationNoiseTimes">æ¬¡</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å‘Šè­¦ -->
                <div style="margin-bottom: 20px;">
                    <!-- é€šçŸ¥ç±»å‹æ ‡é¢˜ -->
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; cursor: pointer;" onclick="toggleAlarmLevel('warning')">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-chevron-down" id="warningChevron" style="color: #64748b; font-size: 12px; transition: transform 0.3s; transform: rotate(-90deg);"></i>
                            <i class="fas fa-exclamation-triangle" style="color: #f59e0b; font-size: 16px;"></i>
                            <span style="font-weight: 600; font-size: 14px; color: #1e293b;" data-translate="notificationWarning">å‘Šè­¦</span>
                            <span style="font-size: 12px; color: #64748b; margin-left: 4px;" data-translate="notificationWarningDesc">éœ€è¦æŸ¥çœ‹å…³æ³¨</span>
                        </div>
                        <label class="switch" onclick="event.stopPropagation()">
                            <input type="checkbox" id="warningEnabled" checked>
                            <span class="switch-slider"></span>
                        </label>
                    </div>

                    <!-- é…ç½®å¡ç‰‡ -->
                    <div id="warningContent" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 0; transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease, border-width 0.3s ease; max-height: 0; opacity: 0; overflow: hidden; border-width: 0;">
                        <!-- é€šçŸ¥æ–¹å¼ -->
                        <div style="margin-bottom: 16px;">
                            <div style="font-size: 13px; color: #64748b; margin-bottom: 8px;" data-translate="notificationMethod">é€šçŸ¥æ–¹å¼</div>
                            <div class="notification-checkbox-group">
                                <div class="notification-checkbox-item">
                                    <input type="checkbox" id="warningSms">
                                    <i class="fas fa-sms" style="color: #64748b;"></i>
                                    <label for="warningSms" data-translate="notificationSms">çŸ­ä¿¡</label>
                                </div>
                                <div class="notification-checkbox-item">
                                    <input type="checkbox" id="warningEmail" checked>
                                    <i class="fas fa-envelope" style="color: #64748b;"></i>
                                    <label for="warningEmail" data-translate="notificationEmail">é‚®ä»¶</label>
                                </div>
                            </div>
                        </div>

                        <!-- æ¶ˆæ¯é™å™ª -->
                        <div style="padding-top: 16px; border-top: 1px solid #e2e8f0;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <i class="fas fa-volume-mute" style="color: #64748b; font-size: 13px;"></i>
                                    <span style="font-size: 13px; color: #64748b;" data-translate="notificationNoise">æ¶ˆæ¯é™å™ª</span>
                                </div>
                                <label class="switch" style="transform: scale(0.85);">
                                    <input type="checkbox" id="warningNoiseEnabled" checked onchange="toggleNoiseConfig('warning', this.checked)">
                                    <span class="switch-slider"></span>
                                </label>
                            </div>
                            <div id="warningNoiseConfig" style="display: block; transition: max-height 0.3s ease, opacity 0.3s ease; overflow: hidden; max-height: 100px; opacity: 1;">
                                <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap; font-size: 13px; color: #64748b;">
                                    <input type="number" class="form-input" id="warningRepeatInterval" value="30" min="1" max="120" style="width: 60px; text-align: center; height: 32px; font-size: 13px;">
                                    <span data-translate="notificationNoiseDesc">åˆ†é’Ÿå†…æœ€å¤šå‘é€</span>
                                    <input type="number" class="form-input" id="warningMaxRepeats" value="3" min="1" max="20" style="width: 50px; text-align: center; height: 32px; font-size: 13px;">
                                    <span data-translate="notificationNoiseTimes">æ¬¡</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- é€šçŸ¥ -->
                <div style="margin-bottom: 20px;">
                    <!-- é€šçŸ¥ç±»å‹æ ‡é¢˜ -->
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; cursor: pointer;" onclick="toggleAlarmLevel('notice')">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-chevron-down" id="noticeChevron" style="color: #64748b; font-size: 12px; transition: transform 0.3s; transform: rotate(-90deg);"></i>
                            <i class="fas fa-info-circle" style="color: #3b82f6; font-size: 16px;"></i>
                            <span style="font-weight: 600; font-size: 14px; color: #1e293b;" data-translate="notificationNotice">é€šçŸ¥</span>
                            <span style="font-size: 12px; color: #64748b; margin-left: 4px;" data-translate="notificationNoticeDesc">çŸ¥é“å°±è¡Œ</span>
                        </div>
                        <label class="switch" onclick="event.stopPropagation()">
                            <input type="checkbox" id="noticeEnabled" checked>
                            <span class="switch-slider"></span>
                        </label>
                    </div>

                    <!-- é…ç½®å¡ç‰‡ -->
                    <div id="noticeContent" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 0; transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease, border-width 0.3s ease; max-height: 0; opacity: 0; overflow: hidden; border-width: 0;">
                        <!-- é€šçŸ¥æ–¹å¼ -->
                        <div style="margin-bottom: 16px;">
                            <div style="font-size: 13px; color: #64748b; margin-bottom: 8px;" data-translate="notificationMethod">é€šçŸ¥æ–¹å¼</div>
                            <div class="notification-checkbox-group">
                                <div class="notification-checkbox-item">
                                    <input type="checkbox" id="noticeSms">
                                    <i class="fas fa-sms" style="color: #64748b;"></i>
                                    <label for="noticeSms" data-translate="notificationSms">çŸ­ä¿¡</label>
                                </div>
                                <div class="notification-checkbox-item">
                                    <input type="checkbox" id="noticeEmail" checked>
                                    <i class="fas fa-envelope" style="color: #64748b;"></i>
                                    <label for="noticeEmail" data-translate="notificationEmail">é‚®ä»¶</label>
                                </div>
                            </div>
                        </div>

                        <!-- æ¶ˆæ¯é™å™ª -->
                        <div style="padding-top: 16px; border-top: 1px solid #e2e8f0;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <i class="fas fa-volume-mute" style="color: #64748b; font-size: 13px;"></i>
                                    <span style="font-size: 13px; color: #64748b;" data-translate="notificationNoise">æ¶ˆæ¯é™å™ª</span>
                                </div>
                                <label class="switch" style="transform: scale(0.85);">
                                    <input type="checkbox" id="noticeNoiseEnabled" checked onchange="toggleNoiseConfig('notice', this.checked)">
                                    <span class="switch-slider"></span>
                                </label>
                            </div>
                            <div id="noticeNoiseConfig" style="display: block; transition: max-height 0.3s ease, opacity 0.3s ease; overflow: hidden; max-height: 100px; opacity: 1;">
                                <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap; font-size: 13px; color: #64748b;">
                                    <input type="number" class="form-input" id="noticeRepeatInterval" value="30" min="1" max="120" style="width: 60px; text-align: center; height: 32px; font-size: 13px;">
                                    <span data-translate="notificationNoiseDesc">åˆ†é’Ÿå†…æœ€å¤šå‘é€</span>
                                    <input type="number" class="form-input" id="noticeMaxRepeats" value="3" min="1" max="20" style="width: 50px; text-align: center; height: 32px; font-size: 13px;">
                                    <span data-translate="notificationNoiseTimes">æ¬¡</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- é¢æ¿åº•éƒ¨ -->
        <div class="notification-panel-footer">
            <button class="btn btn-secondary" onclick="closeNotificationPanel()" data-translate="btnCancel">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="saveNotificationSettings()">
                <i class="fas fa-save" style="margin-right: 4px;"></i><span data-translate="btnSave">ä¿å­˜</span>
            </button>
        </div>
    </div>

    <!-- å¼•å…¥é€šç”¨è„šæœ¬ -->
    <script src="common.js"></script>
    <script src="navbar.js"></script>

    <script>
        // å…¨å±€è§„åˆ™æ•°æ®
        let allRules = [
            // ç³»ç»Ÿæ¨¡ç‰ˆ
            {
                id: 'rule-001',
                nameKey: 'ruleName_batteryHighTemp',
                descKey: 'ruleDesc_batteryHighTemp',
                condKey: 'ruleCond_batteryHighTemp',
                type: 'system',
                notifications: ['çŸ­ä¿¡', 'é‚®ç®±', 'APPæ¨é€'],
                alarmLevel: 'fault',
                status: 'active',
                createTime: '2024-11-28 09:15:30',
                deployedDevices: ['device-001', 'device-002', 'device-005']
            },
            {
                id: 'rule-002',
                nameKey: 'ruleName_batteryLowSOC',
                descKey: 'ruleDesc_batteryLowSOC',
                condKey: 'ruleCond_batteryLowSOC',
                type: 'system',
                notifications: ['çŸ­ä¿¡', 'ç«™å†…ä¿¡'],
                alarmLevel: 'warning',
                status: 'active',
                createTime: '2024-11-26 14:20:15',
                deployedDevices: ['device-001', 'device-003']
            },
            {
                id: 'rule-003',
                nameKey: 'ruleName_inverterOverload',
                descKey: 'ruleDesc_inverterOverload',
                condKey: 'ruleCond_inverterOverload',
                type: 'system',
                notifications: ['çŸ­ä¿¡', 'é‚®ç®±'],
                alarmLevel: 'fault',
                status: 'inactive',
                createTime: '2024-11-25 16:40:22',
                deployedDevices: []
            },
            {
                id: 'rule-004',
                nameKey: 'ruleName_energyAbnormal',
                descKey: 'ruleDesc_energyAbnormal',
                condKey: 'ruleCond_energyAbnormal',
                type: 'system',
                notifications: ['çŸ­ä¿¡', 'é‚®ç®±', 'ç«™å†…ä¿¡'],
                alarmLevel: 'notice',
                status: 'active',
                createTime: '2024-11-15 08:50:10',
                deployedDevices: ['device-001', 'device-002', 'device-003', 'device-005', 'device-006', 'device-007']
            },
            // è‡ªå®šä¹‰ç­–ç•¥
            {
                id: 'rule-101',
                nameKey: 'ruleName_nightCharging',
                descKey: 'ruleDesc_nightCharging',
                condKey: 'ruleCond_nightCharging',
                type: 'custom',
                notifications: ['ç«™å†…ä¿¡'],
                alarmLevel: 'notice',
                status: 'active',
                createTime: '2024-11-20 11:30:00',
                deployedDevices: []
            }
        ];

        // è·å–è§„åˆ™çš„ç¿»è¯‘åç§°
        function getRuleName(rule) {
            return rule.nameKey ? getTranslation(rule.nameKey) : (rule.name || '');
        }

        // è·å–è§„åˆ™çš„ç¿»è¯‘æè¿°
        function getRuleDesc(rule) {
            return rule.descKey ? getTranslation(rule.descKey) : (rule.description || '');
        }

        // è·å–è§„åˆ™çš„ç¿»è¯‘æ¡ä»¶
        function getRuleCond(rule) {
            return rule.condKey ? getTranslation(rule.condKey) : (rule.condition || '');
        }

        let filteredRules = [...allRules];
        let currentRuleId = null; // å½“å‰è¦ä¸‹å‘çš„è§„åˆ™ID

        // ==================== å‚¨èƒ½æŸœè®¾å¤‡å±æ€§é…ç½® ====================
        const CABINET_DEVICE_ATTRIBUTES = {
            battery: {
                label: 'ç”µæ± å‚æ•°',
                labelKey: 'groupBattery',
                icon: 'fa-battery-three-quarters',
                params: [
                    { value: 'soc', labelKey: 'paramSOC', label: 'SOCç”µé‡', unit: '%' },
                    { value: 'soh', labelKey: 'paramSOH', label: 'SOHå¥åº·åº¦', unit: '%' },
                    { value: 'voltage', labelKey: 'paramVoltage', label: 'æ€»ç”µå‹', unit: 'V' },
                    { value: 'current', labelKey: 'paramCurrent', label: 'æ€»ç”µæµ', unit: 'A' },
                    { value: 'power', labelKey: 'paramPower', label: 'æ€»åŠŸç‡', unit: 'kW' },
                    { value: 'cell_voltage_max', labelKey: 'paramCellVoltageMax', label: 'å•ä½“æœ€é«˜ç”µå‹', unit: 'V' },
                    { value: 'cell_voltage_min', labelKey: 'paramCellVoltageMin', label: 'å•ä½“æœ€ä½ç”µå‹', unit: 'V' },
                    { value: 'cell_voltage_diff', labelKey: 'paramCellVoltageDiff', label: 'å•ä½“å‹å·®', unit: 'V' }
                ]
            },
            temperature: {
                label: 'æ¸©åº¦å‚æ•°',
                labelKey: 'groupTemperature',
                icon: 'fa-thermometer-half',
                params: [
                    { value: 'temp_max', labelKey: 'paramTempMax', label: 'æœ€é«˜æ¸©åº¦', unit: 'â„ƒ' },
                    { value: 'temp_min', labelKey: 'paramTempMin', label: 'æœ€ä½æ¸©åº¦', unit: 'â„ƒ' },
                    { value: 'temp_diff', labelKey: 'paramTempDiff', label: 'æ¸©å·®', unit: 'â„ƒ' },
                    { value: 'temp_avg', labelKey: 'paramTempAvg', label: 'å¹³å‡æ¸©åº¦', unit: 'â„ƒ' }
                ]
            },
            system: {
                label: 'ç³»ç»ŸçŠ¶æ€',
                labelKey: 'groupSystem',
                icon: 'fa-microchip',
                params: [
                    { value: 'charge_cycles', labelKey: 'paramChargeCycles', label: 'å……æ”¾ç”µæ¬¡æ•°', unit: 'æ¬¡' },
                    { value: 'insulation_resistance', labelKey: 'paramInsulation', label: 'ç»ç¼˜é˜»å€¼', unit: 'kÎ©' },
                    { value: 'connection_status', labelKey: 'paramConnection', label: 'é€šä¿¡çŠ¶æ€', unit: '' }
                ]
            },
            pcs: {
                label: 'PCSå‚æ•°',
                labelKey: 'groupPCS',
                icon: 'fa-plug',
                params: [
                    { value: 'grid_frequency', labelKey: 'paramGridFreq', label: 'ç”µç½‘é¢‘ç‡', unit: 'Hz' },
                    { value: 'ac_voltage', labelKey: 'paramACVoltage', label: 'äº¤æµç”µå‹', unit: 'V' },
                    { value: 'ac_current', labelKey: 'paramACCurrent', label: 'äº¤æµç”µæµ', unit: 'A' }
                ]
            }
        };

        // åŠ¨æ€åŠ è½½è®¾å¤‡å±æ€§åˆ°è§¦å‘æ¡ä»¶ä¸‹æ‹‰åˆ—è¡¨
        function loadDeviceAttributes() {
            const select = document.getElementById('ruleParameter');
            if (!select) {
                console.warn('âš ï¸ æœªæ‰¾åˆ°ruleParameterå…ƒç´ ');
                return;
            }

            // æ¸…ç©ºç°æœ‰é€‰é¡¹(ä¿ç•™ç¬¬ä¸€ä¸ª"è¯·é€‰æ‹©"é€‰é¡¹)
            select.innerHTML = `<option value="" data-translate="ruleSelectParameter">é€‰æ‹©ç›‘æµ‹å‚æ•°</option>`;

            // æŒ‰åˆ†ç±»æ·»åŠ é€‰é¡¹
            Object.keys(CABINET_DEVICE_ATTRIBUTES).forEach(category => {
                const categoryData = CABINET_DEVICE_ATTRIBUTES[category];

                // æ·»åŠ åˆ†ç»„æ ‡ç­¾
                const optgroup = document.createElement('optgroup');
                optgroup.label = categoryData.label;
                if (categoryData.labelKey) {
                    optgroup.setAttribute('data-translate-label', categoryData.labelKey);
                }

                categoryData.params.forEach(param => {
                    const option = document.createElement('option');
                    option.value = param.value;
                    const unitText = param.unit ? ` (${param.unit})` : '';
                    option.textContent = `${param.label}${unitText}`;
                    if (param.labelKey) {
                        option.setAttribute('data-translate', param.labelKey);
                    }
                    option.setAttribute('data-unit', param.unit);
                    optgroup.appendChild(option);
                });

                select.appendChild(optgroup);
            });

            console.log('âœ… è®¾å¤‡å±æ€§å·²åŠ è½½ï¼Œå…±', select.options.length - 1, 'ä¸ªå‚æ•°');
        }

        // æ¨¡æ‹Ÿè®¾å¤‡æ•°æ®
        const availableDevices = [
            { id: 'device-001', name: 'å‚¨èƒ½æŸœ-AåŒº-01å·', sn: 'SN2024001', site: 'åŒ—äº¬æ€»éƒ¨ç«™', location: 'AåŒº1æ¥¼', status: 'online' },
            { id: 'device-002', name: 'å‚¨èƒ½æŸœ-AåŒº-02å·', sn: 'SN2024002', site: 'åŒ—äº¬æ€»éƒ¨ç«™', location: 'AåŒº2æ¥¼', status: 'online' },
            { id: 'device-003', name: 'å‚¨èƒ½æŸœ-BåŒº-01å·', sn: 'SN2024003', site: 'ä¸Šæµ·åˆ†ç«™', location: 'BåŒº1æ¥¼', status: 'online' },
            { id: 'device-004', name: 'å‚¨èƒ½æŸœ-BåŒº-02å·', sn: 'SN2024004', site: 'ä¸Šæµ·åˆ†ç«™', location: 'BåŒº2æ¥¼', status: 'offline' },
            { id: 'device-005', name: 'å‚¨èƒ½æŸœ-CåŒº-01å·', sn: 'SN2024005', site: 'æ·±åœ³åˆ†ç«™', location: 'CåŒº1æ¥¼', status: 'online' },
            { id: 'device-006', name: 'å‚¨èƒ½æŸœ-CåŒº-02å·', sn: 'SN2024006', site: 'æ·±åœ³åˆ†ç«™', location: 'CåŒº2æ¥¼', status: 'online' },
            { id: 'device-007', name: 'å‚¨èƒ½æŸœ-DåŒº-01å·', sn: 'SN2024007', site: 'å¹¿å·åˆ†ç«™', location: 'DåŒº1æ¥¼', status: 'online' },
            { id: 'device-008', name: 'å‚¨èƒ½æŸœ-DåŒº-02å·', sn: 'SN2024008', site: 'å¹¿å·åˆ†ç«™', location: 'DåŒº2æ¥¼', status: 'offline' }
        ];

        // åˆå§‹åŒ–é¡µé¢
        function initializePage() {
            renderRulesTable();
            // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰èœå•
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.btn-primary')) {
                    document.getElementById('createMenu').classList.remove('show');
                }
            });

            // é™å™ªé…ç½®ï¼šæ™ºèƒ½é™å™ªå¼€å…³
            const smartNoiseReductionEnabled = document.getElementById('smartNoiseReductionEnabled');
            const smartNoiseReductionConfig = document.getElementById('smartNoiseReductionConfig');
            if (smartNoiseReductionEnabled && smartNoiseReductionConfig) {
                smartNoiseReductionEnabled.addEventListener('change', function() {
                    smartNoiseReductionConfig.style.display = this.checked ? 'block' : 'none';
                });
            }

            // è‡ªåŠ¨æ¶ˆè­¦å¼€å…³
            const autoResolutionEnabled = document.getElementById('autoResolutionEnabled');
            const autoResolutionConfig = document.getElementById('autoResolutionConfig');
            if (autoResolutionEnabled && autoResolutionConfig) {
                autoResolutionEnabled.addEventListener('change', function() {
                    autoResolutionConfig.style.display = this.checked ? 'block' : 'none';
                });
            }

        }

        // æ¸²æŸ“è§„åˆ™è¡¨æ ¼
        function renderRulesTable() {
            const tbody = document.getElementById('rulesTableBody');

            if (filteredRules.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="no-data-cell">
                            <i class="fas fa-folder-open no-data-icon"></i>
                            <div class="no-data-text">${getTranslation('ruleNoDataTitle')}</div>
                            <div class="no-data-subtext">${getTranslation('ruleNoDataSubtitle')}</div>
                        </td>
                    </tr>
                `;
                return;
            }

            // è·å–é€šçŸ¥ç±»å‹ç¿»è¯‘
            const alarmLevelLabels = {
                fault: getTranslation('ruleAlarmLevelFault'),
                warning: getTranslation('ruleAlarmLevelWarning'),
                notice: getTranslation('ruleAlarmLevelNotice')
            };

            tbody.innerHTML = filteredRules.map(rule => `
                <tr>
                    <td class="rule-name-cell">
                        <div class="rule-name">${getRuleName(rule)}</div>
                        <div class="rule-description">${getRuleDesc(rule)}</div>
                    </td>
                    <td style="color: var(--text-secondary); font-size: 13px;">
                        ${getRuleCond(rule)}
                    </td>
                    <td>
                        <span class="alarm-level-badge ${rule.alarmLevel}">
                            ${alarmLevelLabels[rule.alarmLevel] || rule.alarmLevel}
                        </span>
                    </td>
                    <td>
                        <label class="switch">
                            <input type="checkbox" ${rule.status === 'active' ? 'checked' : ''} onchange="toggleRuleStatus('${rule.id}', this.checked)">
                            <span class="switch-slider"></span>
                        </label>
                    </td>
                    <td style="text-align: center;">
                        <span onclick="sendToDevice('${rule.id}')" style="color: #3562E3; font-size: 14px; font-weight: 500; cursor: pointer; text-decoration: none; transition: all 0.2s;" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">
                            ${rule.deployedDevices ? rule.deployedDevices.length : 0}
                        </span>
                    </td>
                    <td class="rule-time-cell">${rule.createTime}</td>
                    <td style="text-align: center; white-space: nowrap;" onclick="event.stopPropagation()">
                        <button class="btn" onclick="editRule('${rule.id}')" style="padding: 0; width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center; margin-right: 8px; border: none; background: transparent; border-radius: 6px; cursor: pointer;" title="${getTranslation('btnEdit') || 'Edit'}">
                            <i class="far fa-edit" style="font-size: 16px; color: var(--text-secondary);"></i>
                        </button>
                        <button class="btn" onclick="deleteRule('${rule.id}')" style="padding: 0; width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center; border: none; background: transparent; border-radius: 6px; cursor: ${rule.deployedDevices && rule.deployedDevices.length > 0 ? 'not-allowed' : 'pointer'}; opacity: ${rule.deployedDevices && rule.deployedDevices.length > 0 ? '0.5' : '1'};" title="${getTranslation('btnDelete') || 'Delete'}">
                            <i class="far fa-trash-alt" style="font-size: 16px; color: ${rule.deployedDevices && rule.deployedDevices.length > 0 ? '#cbd5e1' : '#ef4444'};"></i>
                        </button>
                    </td>
                </tr>
            `).join('');

            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            updateStats();
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStats() {
            // ç»Ÿè®¡æ‰€æœ‰ç­–ç•¥(ä¸å—è¿‡æ»¤å½±å“)
            const faultRules = allRules.filter(rule => rule.alarmLevel === 'fault');
            const warningRules = allRules.filter(rule => rule.alarmLevel === 'warning');
            const noticeRules = allRules.filter(rule => rule.alarmLevel === 'notice');

            // ç»Ÿè®¡å¯ç”¨çš„ç­–ç•¥
            const faultActiveRules = faultRules.filter(rule => rule.status === 'active');
            const warningActiveRules = warningRules.filter(rule => rule.status === 'active');
            const noticeActiveRules = noticeRules.filter(rule => rule.status === 'active');

            // æ›´æ–°å¯ç”¨ç­–ç•¥æ•°é‡(å¤§æ•°å­—æ˜¾ç¤º)
            document.getElementById('faultCount').textContent = faultActiveRules.length;
            document.getElementById('warningCount').textContent = warningActiveRules.length;
            document.getElementById('noticeCount').textContent = noticeActiveRules.length;

            // æ›´æ–°æ€»ç­–ç•¥æ•°é‡(ä¸‹æ–¹å°å­—æ˜¾ç¤º)
            document.getElementById('faultTotalCount').textContent = faultRules.length;
            document.getElementById('warningTotalCount').textContent = warningRules.length;
            document.getElementById('noticeTotalCount').textContent = noticeRules.length;
        }

        // åˆ‡æ¢åˆ›å»ºèœå•
        function toggleCreateMenu() {
            const menu = document.getElementById('createMenu');
            menu.classList.toggle('show');
        }

        // ä»æ¨¡ç‰ˆåˆ›å»º
        function createFromTemplate() {
            document.getElementById('createMenu').classList.remove('show');
            document.getElementById('templateModal').style.display = 'flex';
            // é»˜è®¤æ˜¾ç¤ºé€†å˜å™¨åˆ†ç±»
            switchTemplateTab('inverter');
        }

        // åˆ‡æ¢æ¨¡æ¿åˆ†ç±»æ ‡ç­¾é¡µ
        function switchTemplateTab(category) {
            // ç§»é™¤æ‰€æœ‰ active çŠ¶æ€
            document.querySelectorAll('.template-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // æ·»åŠ å½“å‰ tab çš„ active çŠ¶æ€
            document.querySelector(`.template-tab[data-tab="${category}"]`).classList.add('active');

            // éšè—æ‰€æœ‰åˆ†ç±»
            document.querySelectorAll('.template-category').forEach(cat => {
                cat.style.display = 'none';
            });

            // æ˜¾ç¤ºå½“å‰åˆ†ç±»
            document.getElementById(`${category}-templates`).style.display = 'grid';
        }

        // è‡ªå®šä¹‰ç­–ç•¥
        function createCustomRule() {
            document.getElementById('createMenu').classList.remove('show');
            openRuleModal();
        }

        // é€‰æ‹©æ¨¡ç‰ˆ
        function selectTemplate(templateId) {
            closeTemplateModal();
            // å…ˆæ‰“å¼€æ¨¡æ€æ¡†
            openRuleModal();

            // æ ¹æ®æ¨¡ç‰ˆIDå¡«å……è¡¨å•ï¼ˆå»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿æ¨¡æ€æ¡†å·²æ‰“å¼€ï¼‰
            setTimeout(() => {
                const templates = {
                    // é€†å˜å™¨æ¨¡æ¿
                    'inverterOverload': {
                        nameKey: 'ruleName_inverterOverload',
                        descKey: 'ruleDesc_inverterOverload',
                        parameter: 'power',
                        operator: 'gt',
                        threshold: 110,
                        duration: 2,
                        alarmLevel: 'fault'
                    },
                    'inverterFault': {
                        nameKey: 'ruleName_inverterFault',
                        descKey: 'ruleDesc_inverterFault',
                        parameter: 'power',
                        operator: 'lt',
                        threshold: 10,
                        duration: 5,
                        alarmLevel: 'fault'
                    },
                    'inverterTemp': {
                        nameKey: 'ruleName_inverterTemp',
                        descKey: 'ruleDesc_inverterTemp',
                        parameter: 'temperature',
                        operator: 'gt',
                        threshold: 65,
                        duration: 3,
                        alarmLevel: 'warning'
                    },
                    // ç”µæ± æ¨¡æ¿
                    'batteryHighTemp': {
                        nameKey: 'ruleName_batteryHighTemp',
                        descKey: 'ruleDesc_batteryHighTemp',
                        parameter: 'temperature',
                        operator: 'gt',
                        threshold: 55,
                        duration: 5,
                        alarmLevel: 'fault'
                    },
                    'batteryLowSOC': {
                        nameKey: 'ruleName_batteryLowSOC',
                        descKey: 'ruleDesc_batteryLowSOC',
                        parameter: 'soc',
                        operator: 'lt',
                        threshold: 20,
                        duration: 3,
                        alarmLevel: 'warning'
                    },
                    'batteryVoltageDiff': {
                        nameKey: 'ruleName_batteryVoltageDiff',
                        descKey: 'ruleDesc_batteryVoltageDiff',
                        parameter: 'voltage',
                        operator: 'gt',
                        threshold: 0.3,
                        duration: 2,
                        alarmLevel: 'fault'
                    },
                    'batteryOverCurrent': {
                        nameKey: 'ruleName_batteryOverCurrent',
                        descKey: 'ruleDesc_batteryOverCurrent',
                        parameter: 'current',
                        operator: 'gt',
                        threshold: 100,
                        duration: 1,
                        alarmLevel: 'fault'
                    },
                    // ç”µè¡¨æ¨¡æ¿
                    'energyAbnormal': {
                        nameKey: 'ruleName_energyAbnormal',
                        descKey: 'ruleDesc_energyAbnormal',
                        parameter: 'power',
                        operator: 'gt',
                        threshold: 30,
                        duration: 10,
                        alarmLevel: 'notice'
                    },
                    'powerOverload': {
                        nameKey: 'ruleName_powerOverload',
                        descKey: 'ruleDesc_powerOverload',
                        parameter: 'power',
                        operator: 'gt',
                        threshold: 100,
                        duration: 5,
                        alarmLevel: 'fault'
                    },
                    'voltageAbnormal': {
                        nameKey: 'ruleName_voltageAbnormal',
                        descKey: 'ruleDesc_voltageAbnormal',
                        parameter: 'voltage',
                        operator: 'lt',
                        threshold: 220,
                        duration: 1,
                        alarmLevel: 'fault'
                    },
                    'currentAbnormal': {
                        nameKey: 'ruleName_currentAbnormal',
                        descKey: 'ruleDesc_currentAbnormal',
                        parameter: 'current',
                        operator: 'gt',
                        threshold: 50,
                        duration: 2,
                        alarmLevel: 'warning'
                    },
                    // æ¸©åº¦æ¨¡æ¿
                    'envTempHigh': {
                        nameKey: 'ruleName_envTempHigh',
                        descKey: 'ruleDesc_envTempHigh',
                        parameter: 'temperature',
                        operator: 'gt',
                        threshold: 35,
                        duration: 10,
                        alarmLevel: 'warning'
                    },
                    'envTempLow': {
                        nameKey: 'ruleName_envTempLow',
                        descKey: 'ruleDesc_envTempLow',
                        parameter: 'temperature',
                        operator: 'lt',
                        threshold: 0,
                        duration: 10,
                        alarmLevel: 'warning'
                    },
                    'humidityHigh': {
                        nameKey: 'ruleName_humidityHigh',
                        descKey: 'ruleDesc_humidityHigh',
                        parameter: 'power',
                        operator: 'gt',
                        threshold: 85,
                        duration: 15,
                        alarmLevel: 'warning'
                    },
                    'deviceTempHigh': {
                        nameKey: 'ruleName_deviceTempHigh',
                        descKey: 'ruleDesc_deviceTempHigh',
                        parameter: 'temperature',
                        operator: 'gt',
                        threshold: 70,
                        duration: 5,
                        alarmLevel: 'fault'
                    },
                    // æ¶ˆé˜²æ¨¡æ¿
                    'smokeAlarm': {
                        nameKey: 'ruleName_smokeAlarm',
                        descKey: 'ruleDesc_smokeAlarm',
                        parameter: 'power',
                        operator: 'gt',
                        threshold: 0,
                        duration: 0,
                        alarmLevel: 'fault'
                    },
                    'fireAlarm': {
                        nameKey: 'ruleName_fireAlarm',
                        descKey: 'ruleDesc_fireAlarm',
                        parameter: 'temperature',
                        operator: 'gt',
                        threshold: 80,
                        duration: 0,
                        alarmLevel: 'fault'
                    },
                    'waterLeakage': {
                        nameKey: 'ruleName_waterLeakage',
                        descKey: 'ruleDesc_waterLeakage',
                        parameter: 'power',
                        operator: 'gt',
                        threshold: 0,
                        duration: 0,
                        alarmLevel: 'fault'
                    },
                    'gasLeakage': {
                        nameKey: 'ruleName_gasLeakage',
                        descKey: 'ruleDesc_gasLeakage',
                        parameter: 'power',
                        operator: 'gt',
                        threshold: 0,
                        duration: 0,
                        alarmLevel: 'fault'
                    }
                };

                const template = templates[templateId];
                if (template) {
                    const templateName = getTranslation(template.nameKey);
                    const templateDesc = getTranslation(template.descKey);
                    document.getElementById('ruleName').value = templateName + getTranslation('ruleTemplateCopySuffix');
                    document.getElementById('ruleDescription').value = templateDesc;
                    document.getElementById('ruleParameter').value = template.parameter;
                    document.getElementById('ruleOperator').value = template.operator;
                    document.getElementById('ruleThreshold').value = template.threshold;
                    document.getElementById('ruleDuration').value = template.duration;
                    document.getElementById('ruleAlarmLevel').value = template.alarmLevel;
                }
            }, 50);
        }

        // æ‰“å¼€è§„åˆ™æ¨¡æ€æ¡†
        function openRuleModal(ruleId = null) {
            const modal = document.getElementById('ruleModal');
            const modalTitle = document.getElementById('modalTitle');

            // âœ… åŠ¨æ€åŠ è½½è®¾å¤‡å±æ€§(ç¡®ä¿æ¯æ¬¡æ‰“å¼€æ¨¡æ€æ¡†éƒ½é‡æ–°åŠ è½½)
            loadDeviceAttributes();

            if (ruleId) {
                modalTitle.textContent = getTranslation('ruleModalEditTitle');
                // åŠ è½½è§„åˆ™æ•°æ®
                const rule = allRules.find(r => r.id === ruleId);
                if (rule) {
                    document.getElementById('ruleName').value = getRuleName(rule);
                    document.getElementById('ruleDescription').value = getRuleDesc(rule);
                    // å¡«å……å…¶ä»–å­—æ®µ...

                    // åŠ è½½é™å™ªé…ç½®
                    if (rule.noiseReduction) {
                        // æ™ºèƒ½é™å™ªé…ç½®
                        const smartNoiseEnabled = document.getElementById('smartNoiseReductionEnabled');
                        const noiseWindow = document.getElementById('noiseReductionWindow');

                        // å…¼å®¹æ—§æ•°æ®ï¼šå¦‚æœæ˜¯æ—§æ ¼å¼ï¼ˆdeduplication/aggregationï¼‰ï¼Œè½¬æ¢ä¸ºæ–°æ ¼å¼
                        if (rule.noiseReduction.smartNoiseReduction) {
                            smartNoiseEnabled.checked = rule.noiseReduction.smartNoiseReduction.enabled;
                            noiseWindow.value = rule.noiseReduction.smartNoiseReduction.window;
                        } else if (rule.noiseReduction.deduplication) {
                            // å…¼å®¹æ—§æ•°æ®
                            smartNoiseEnabled.checked = rule.noiseReduction.deduplication.enabled;
                            noiseWindow.value = rule.noiseReduction.deduplication.window;
                        }
                        document.getElementById('smartNoiseReductionConfig').style.display =
                            smartNoiseEnabled.checked ? 'block' : 'none';

                        // å‘Šè­¦æ¶ˆè­¦é…ç½®ï¼ˆå…¼å®¹æ–°æ—§æ•°æ®æ ¼å¼ï¼‰
                        const autoResEnabled = document.getElementById('autoResolutionEnabled');
                        const autoResCondition = document.getElementById('autoResolutionCondition');
                        const autoResDelay = document.getElementById('autoResolutionDelay');

                        if (rule.noiseReduction.autoResolution) {
                            // æ–°æ ¼å¼
                            autoResEnabled.checked = rule.noiseReduction.autoResolution.enabled;
                            autoResCondition.value = rule.noiseReduction.autoResolution.condition || 'normal';
                            autoResDelay.value = rule.noiseReduction.autoResolution.delay || 5;
                        } else if (rule.noiseReduction.resolution) {
                            // å…¼å®¹æ—§æ ¼å¼
                            autoResEnabled.checked = rule.noiseReduction.resolution.autoResolution.enabled;
                            autoResCondition.value = rule.noiseReduction.resolution.autoResolution.condition || 'normal';
                            autoResDelay.value = rule.noiseReduction.resolution.autoResolution.delay || 5;
                        }

                        document.getElementById('autoResolutionConfig').style.display =
                            autoResEnabled.checked ? 'block' : 'none';
                    }
                }
            } else {
                modalTitle.textContent = getTranslation('ruleModalNewTitle');
                document.getElementById('ruleForm').reset();

                // é‡ç½®é™å™ªé…ç½®
                document.getElementById('smartNoiseReductionEnabled').checked = false;
                document.getElementById('smartNoiseReductionConfig').style.display = 'none';

                // é‡ç½®æ¶ˆè­¦é…ç½®
                document.getElementById('autoResolutionEnabled').checked = true;
                document.getElementById('autoResolutionConfig').style.display = 'block';
                document.getElementById('autoResolutionCondition').value = 'normal';
                document.getElementById('autoResolutionDelay').value = '5';
            }

            modal.style.display = 'flex';

            // âœ… ç¡®ä¿selectå…ƒç´ å¯äº¤äº’(å»¶è¿Ÿæ‰§è¡Œä»¥ç¡®ä¿DOMå·²æ›´æ–°)
            setTimeout(() => {
                const ruleParameter = document.getElementById('ruleParameter');
                const ruleOperator = document.getElementById('ruleOperator');
                const ruleThreshold = document.getElementById('ruleThreshold');

                if (ruleParameter) {
                    ruleParameter.style.pointerEvents = 'auto';
                    ruleParameter.style.position = 'relative';
                    ruleParameter.style.zIndex = '1';
                    ruleParameter.disabled = false;
                    console.log('âœ… ruleParameterå·²æ¿€æ´»ï¼Œé€‰é¡¹æ•°:', ruleParameter.options.length);
                }

                if (ruleOperator) {
                    ruleOperator.disabled = false;
                }

                if (ruleThreshold) {
                    ruleThreshold.disabled = false;
                }
            }, 100);
        }

        // å…³é—­è§„åˆ™æ¨¡æ€æ¡†
        function closeRuleModal() {
            document.getElementById('ruleModal').style.display = 'none';
        }

        // å…³é—­æ¨¡ç‰ˆæ¨¡æ€æ¡†
        function closeTemplateModal() {
            document.getElementById('templateModal').style.display = 'none';
        }

        // ä¿å­˜è§„åˆ™
        function saveRule() {
            const name = document.getElementById('ruleName').value;
            const description = document.getElementById('ruleDescription').value;
            const parameter = document.getElementById('ruleParameter').value;
            const operator = document.getElementById('ruleOperator').value;
            const threshold = document.getElementById('ruleThreshold').value;
            const duration = document.getElementById('ruleDuration').value;
            const alarmLevel = document.getElementById('ruleAlarmLevel').value;
            const status = document.getElementById('ruleStatus').checked ? 'active' : 'inactive';

            if (!name || !parameter || !operator || !threshold || !alarmLevel) {
                showNotification(getTranslation('ruleNotifyFillRequired'), 'warning');
                return;
            }

            // æ„é€ æ¡ä»¶æè¿°ï¼ˆä½¿ç”¨ç¿»è¯‘ï¼‰
            const paramLabels = {
                temperature: getTranslation('ruleParamTemp'),
                soc: 'SOC',
                voltage: getTranslation('ruleParamVoltage'),
                current: getTranslation('ruleParamCurrent'),
                power: getTranslation('ruleParamPower')
            };
            const operatorLabels = { gt: '>', lt: '<', gte: '>=', lte: '<=', eq: '=' };
            const durationText = getTranslation('ruleConditionDuration').replace('{minutes}', duration || 0);
            const condition = `${paramLabels[parameter]} ${operatorLabels[operator]} ${threshold} ${durationText}`;

            // æ”¶é›†é™å™ªé…ç½®
            const noiseReduction = {
                smartNoiseReduction: {
                    enabled: document.getElementById('smartNoiseReductionEnabled').checked,
                    window: document.getElementById('noiseReductionWindow').value
                },
                autoResolution: {
                    enabled: document.getElementById('autoResolutionEnabled').checked,
                    condition: document.getElementById('autoResolutionCondition').value,
                    delay: parseInt(document.getElementById('autoResolutionDelay').value) || 5
                }
            };

            const newRule = {
                id: 'rule-' + Date.now(),
                name,
                description,
                type: 'custom',
                condition,
                alarmLevel,
                status,
                noiseReduction,
                createTime: new Date().toLocaleString('zh-CN', { hour12: false }).replace(/\//g, '-'),
                deployedDevices: []
            };

            allRules.unshift(newRule);
            filteredRules = [...allRules];
            renderRulesTable();
            closeRuleModal();
            showNotification(getTranslation('ruleNotifyCreateSuccess'), 'success');
        }

        // æŸ¥çœ‹è§„åˆ™è¯¦æƒ…
        function viewRuleDetails(ruleId) {
            const rule = allRules.find(r => r.id === ruleId);
            if (rule) {
                showNotification(getTranslation('ruleViewRule').replace('{name}', getRuleName(rule)), 'info');
            }
        }

        // ç¼–è¾‘è§„åˆ™
        function editRule(ruleId) {
            openRuleModal(ruleId);
        }

        // å¤åˆ¶è§„åˆ™
        function copyRule(ruleId) {
            const rule = allRules.find(r => r.id === ruleId);
            if (rule) {
                const newRule = {
                    ...rule,
                    id: 'rule-' + Date.now(),
                    name: getRuleName(rule) + getTranslation('ruleTemplateCopySuffix'),
                    nameKey: null, // å¤åˆ¶çš„è§„åˆ™ä½¿ç”¨ name å­—æ®µè€Œé nameKey
                    descKey: null, // åŒç†
                    condKey: null,
                    description: getRuleDesc(rule),
                    condition: getRuleCond(rule),
                    type: 'custom',
                    createTime: new Date().toLocaleString('zh-CN', { hour12: false }).replace(/\//g, '-'),
                    deployedDevices: [] // å¤åˆ¶çš„è§„åˆ™ä¸ç»§æ‰¿å·²ä¸‹å‘è®¾å¤‡
                };
                allRules.unshift(newRule);
                filteredRules = [...allRules];
                renderRulesTable();
                showNotification(getTranslation('ruleNotifyCopySuccess'), 'success');
            }
        }

        // åˆ é™¤è§„åˆ™
        function deleteRule(ruleId) {
            const rule = allRules.find(r => r.id === ruleId);
            if (!rule) return;

            // æ£€æŸ¥æ˜¯å¦æœ‰ä¸‹å‘è®¾å¤‡
            if (rule.deployedDevices && rule.deployedDevices.length > 0) {
                showNotification(getTranslation('ruleNotifyRemoveDeviceFirst'), 'error');
                return;
            }

            if (confirm(getTranslation('ruleNotifyDeleteConfirm'))) {
                allRules = allRules.filter(r => r.id !== ruleId);
                filteredRules = filteredRules.filter(r => r.id !== ruleId);
                renderRulesTable();
                showNotification(getTranslation('ruleNotifyDeleteSuccess'), 'success');
            }
        }

        // åˆ‡æ¢è§„åˆ™çŠ¶æ€
        function toggleRuleStatus(ruleId, isActive) {
            const rule = allRules.find(r => r.id === ruleId);
            if (rule) {
                rule.status = isActive ? 'active' : 'inactive';
                // æ›´æ–°filteredRulesä¸­å¯¹åº”çš„è§„åˆ™
                const filteredRule = filteredRules.find(r => r.id === ruleId);
                if (filteredRule) {
                    filteredRule.status = rule.status;
                }
                showNotification(isActive ? getTranslation('ruleNotifyEnabled') : getTranslation('ruleNotifyDisabled'), 'success');
            }
        }

        // ç»¼åˆè¿‡æ»¤è§„åˆ™
        function filterRules() {
            const alarmLevel = document.getElementById('ruleAlarmLevelFilter').value;
            const status = document.getElementById('ruleStatusFilter').value;
            const keyword = document.getElementById('ruleSearchInput').value.trim();

            filteredRules = allRules.filter(rule => {
                // é€šçŸ¥ç±»å‹è¿‡æ»¤
                if (alarmLevel !== 'all' && rule.alarmLevel !== alarmLevel) {
                    return false;
                }
                // å¯ç”¨çŠ¶æ€è¿‡æ»¤
                if (status !== 'all' && rule.status !== status) {
                    return false;
                }
                // å…³é”®è¯æœç´¢
                if (keyword) {
                    const ruleName = getRuleName(rule);
                    const ruleDesc = getRuleDesc(rule);
                    const ruleCond = getRuleCond(rule);
                    return ruleName.includes(keyword) ||
                           ruleDesc.includes(keyword) ||
                           ruleCond.includes(keyword);
                }
                return true;
            });

            renderRulesTable();
        }

        // æœç´¢ç­–ç•¥
        function searchRules(keyword) {
            filterRules();
        }

        // åˆ·æ–°ç­–ç•¥åˆ—è¡¨
        function refreshRuleList() {
            document.getElementById('ruleSearchInput').value = '';
            document.getElementById('ruleAlarmLevelFilter').value = 'all';
            document.getElementById('ruleStatusFilter').value = 'all';
            filteredRules = [...allRules];
            renderRulesTable();
            showNotification(getTranslation('ruleNotifyRefreshSuccess'), 'success');
        }

        // æ‰“å¼€å·²ä¸‹å‘è®¾å¤‡æŠ½å±‰
        function sendToDevice(ruleId) {
            currentRuleId = ruleId;
            const rule = allRules.find(r => r.id === ruleId);
            if (rule) {
                const deployedCount = rule.deployedDevices ? rule.deployedDevices.length : 0;
                document.getElementById('drawerSubtitle').textContent = getTranslation('ruleDrawerSubtitle').replace('{name}', getRuleName(rule)).replace('{count}', deployedCount);

                const drawer = document.getElementById('deviceDrawer');
                const drawerContent = drawer.querySelector('div:last-child');
                drawer.style.display = 'block';
                setTimeout(() => {
                    drawerContent.style.right = '0';
                }, 10);

                renderDeviceList();
            }
        }

        // å…³é—­å·²ä¸‹å‘è®¾å¤‡æŠ½å±‰
        function closeDeviceDrawer() {
            const drawer = document.getElementById('deviceDrawer');
            const drawerContent = drawer.querySelector('div:last-child');
            drawerContent.style.right = '-450px';
            setTimeout(() => {
                drawer.style.display = 'none';
            }, 300);
            currentRuleId = null;
        }

        // æ¸²æŸ“å·²ä¸‹å‘è®¾å¤‡åˆ—è¡¨
        function renderDeviceList() {
            const rule = allRules.find(r => r.id === currentRuleId);
            if (!rule) return;

            const deployedDevices = rule.deployedDevices || [];
            const deployedListContainer = document.getElementById('deployedDeviceList');

            // å¡«å……SNå’Œç«™ç‚¹ä¸‹æ‹‰åˆ—è¡¨
            const snFilter = document.getElementById('snFilter');
            const siteFilter = document.getElementById('siteFilter');

            // æ”¶é›†æ‰€æœ‰å”¯ä¸€çš„SNå’Œç«™ç‚¹
            const uniqueSNs = new Set();
            const uniqueSites = new Set();

            deployedDevices.forEach(deviceId => {
                const device = availableDevices.find(d => d.id === deviceId);
                if (device) {
                    uniqueSNs.add(device.sn);
                    uniqueSites.add(device.site);
                }
            });

            // å¡«å……SNä¸‹æ‹‰åˆ—è¡¨
            snFilter.innerHTML = `<option value="">${getTranslation('ruleFilterAllSN')}</option>` +
                Array.from(uniqueSNs).map(sn => `<option value="${sn}">${sn}</option>`).join('');

            // å¡«å……ç«™ç‚¹ä¸‹æ‹‰åˆ—è¡¨
            siteFilter.innerHTML = `<option value="">${getTranslation('ruleFilterAllSite')}</option>` +
                Array.from(uniqueSites).map(site => `<option value="${site}">${site}</option>`).join('');

            if (deployedDevices.length === 0) {
                deployedListContainer.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                            <i class="fas fa-inbox" style="font-size: 48px; opacity: 0.3; margin-bottom: 16px; display: block;"></i>
                            <div style="font-size: 14px;">${getTranslation('ruleNoDeployedDevices')}</div>
                        </td>
                    </tr>
                `;
            } else {
                deployedListContainer.innerHTML = deployedDevices.map(deviceId => {
                    const device = availableDevices.find(d => d.id === deviceId);
                    if (!device) return '';
                    return `
                        <tr style="border-bottom: 1px solid var(--border-color); transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='var(--bg-secondary)'" onmouseout="this.style.backgroundColor=''">
                            <td style="padding: 14px 8px; text-align: center;">
                                <input type="checkbox" class="deployed-device-checkbox" data-device-id="${deviceId}" style="cursor: pointer;">
                            </td>
                            <td style="padding: 14px 8px; font-size: 13px; color: var(--text-primary);">${device.sn}</td>
                            <td style="padding: 14px 8px; font-size: 13px; color: var(--text-primary);">${device.site}</td>
                            <td style="padding: 14px 8px; text-align: center;">
                                <button class="btn" onclick="removeDeployedDevice('${deviceId}')" style="padding: 0; width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center; border: none; background: transparent; border-radius: 6px; cursor: pointer;" title="${getTranslation('ruleBtnRemove')}">
                                    <i class="far fa-trash-alt" style="font-size: 16px; color: #ef4444;"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
        }

        // ç­›é€‰å·²ä¸‹å‘è®¾å¤‡
        function filterDeployedDevices() {
            const snFilter = document.getElementById('snFilter').value;
            const siteFilter = document.getElementById('siteFilter').value;
            const rows = document.querySelectorAll('#deployedDeviceList tr');

            rows.forEach(row => {
                // è·³è¿‡ç©ºçŠ¶æ€è¡Œ
                if (row.cells.length < 3) {
                    return;
                }

                const sn = row.cells[0].textContent.trim();
                const site = row.cells[1].textContent.trim();

                const snMatch = !snFilter || sn.includes(snFilter);
                const siteMatch = !siteFilter || site === siteFilter;

                if (snMatch && siteMatch) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // é‡ç½®å·²ä¸‹å‘è®¾å¤‡ç­›é€‰
        function resetDeployedDevicesFilter() {
            document.getElementById('snFilter').value = '';
            document.getElementById('siteFilter').value = '';
            const rows = document.querySelectorAll('#deployedDeviceList tr');
            rows.forEach(row => {
                row.style.display = '';
            });
        }

        // æ‰“å¼€æ·»åŠ è®¾å¤‡æ¨¡æ€æ¡†
        function openAddDeviceModal() {
            const rule = allRules.find(r => r.id === currentRuleId);
            if (!rule) return;

            const deployedDevices = rule.deployedDevices || [];

            // ç­›é€‰æœªä¸‹å‘çš„åœ¨çº¿è®¾å¤‡
            window.availableDevicesFiltered = availableDevices.filter(device =>
                !deployedDevices.includes(device.id) && device.status === 'online'
            );

            // å¡«å……ç«™ç‚¹ä¸‹æ‹‰æ¡†
            const uniqueSites = new Set();
            window.availableDevicesFiltered.forEach(device => {
                uniqueSites.add(device.site);
            });
            const deviceSiteFilter = document.getElementById('deviceSiteFilter');
            deviceSiteFilter.innerHTML = `<option value="">${getTranslation('ruleFilterAllSite')}</option>` +
                Array.from(uniqueSites).map(site => `<option value="${site}">${site}</option>`).join('');

            renderAvailableDeviceTable();

            // æ¸…ç©ºæœç´¢æ¡†
            document.getElementById('deviceSearchInput').value = '';
            document.getElementById('deviceSiteFilter').value = '';
            document.getElementById('selectAllNewDevices').checked = false;

            document.getElementById('addDeviceModal').style.display = 'flex';
        }

        // æ¸²æŸ“å¯æ·»åŠ è®¾å¤‡è¡¨æ ¼
        function renderAvailableDeviceTable(filteredDevices = null) {
            const devices = filteredDevices || window.availableDevicesFiltered || [];
            const availableListContainer = document.getElementById('availableDeviceList');

            if (devices.length === 0) {
                const hasFilter = document.getElementById('deviceSearchInput').value || document.getElementById('deviceSiteFilter').value;
                availableListContainer.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                            <i class="fas fa-check-circle" style="font-size: 48px; color: #10b981; opacity: 0.3; margin-bottom: 16px; display: block;"></i>
                            <div style="font-size: 14px;">${hasFilter ? getTranslation('ruleNoMatchingDevices') : getTranslation('ruleAllDevicesDeployed')}</div>
                        </td>
                    </tr>
                `;
                return;
            }

            availableListContainer.innerHTML = devices.map(device => `
                <tr style="border-bottom: 1px solid var(--border-color); transition: background-color 0.2s; cursor: pointer;"
                    onmouseover="this.style.backgroundColor='#f9fafb'"
                    onmouseout="this.style.backgroundColor=''"
                    onclick="toggleDeviceCheckbox('${device.id}')">
                    <td style="text-align: center; padding: 12px 16px;">
                        <input
                            type="checkbox"
                            class="new-device-checkbox"
                            value="${device.id}"
                            id="checkbox-${device.id}"
                            style="width: 18px; height: 18px; cursor: pointer;"
                            onclick="event.stopPropagation()"
                        />
                    </td>
                    <td style="padding: 12px 16px; font-size: 13px; color: var(--text-primary); font-weight: 500;">
                        ${device.name}
                    </td>
                    <td style="padding: 12px 16px; font-size: 13px; color: var(--text-secondary);">
                        ${device.sn}
                    </td>
                    <td style="padding: 12px 16px; font-size: 13px; color: var(--text-secondary);">
                        ${device.site}
                    </td>
                    <td style="text-align: center; padding: 12px 16px;">
                        <span style="display: inline-flex; align-items: center; gap: 4px; font-size: 12px; font-weight: 500; color: #10b981;">
                            <i class="fas fa-circle" style="font-size: 6px;"></i>
                            ${getTranslation('ruleDeviceOnline')}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        // ç‚¹å‡»è¡Œåˆ‡æ¢å¤é€‰æ¡†
        function toggleDeviceCheckbox(deviceId) {
            const checkbox = document.getElementById(`checkbox-${deviceId}`);
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
            }
        }

        // åº”ç”¨è®¾å¤‡ç­›é€‰
        function applyDeviceFilter() {
            if (!window.availableDevicesFiltered) return;

            const snKeyword = document.getElementById('deviceSearchInput').value.trim();
            const siteFilter = document.getElementById('deviceSiteFilter').value;

            if (!snKeyword && !siteFilter) {
                renderAvailableDeviceTable();
                return;
            }

            const filtered = window.availableDevicesFiltered.filter(device => {
                const snMatch = !snKeyword || device.sn.toLowerCase().includes(snKeyword.toLowerCase());
                const siteMatch = !siteFilter || device.site === siteFilter;
                return snMatch && siteMatch;
            });

            renderAvailableDeviceTable(filtered);
        }

        // é‡ç½®è®¾å¤‡ç­›é€‰
        function resetDeviceFilter() {
            document.getElementById('deviceSearchInput').value = '';
            document.getElementById('deviceSiteFilter').value = '';
            renderAvailableDeviceTable();
        }

        // å…³é—­æ·»åŠ è®¾å¤‡æ¨¡æ€æ¡†
        function closeAddDeviceModal() {
            document.getElementById('addDeviceModal').style.display = 'none';
            document.getElementById('selectAllNewDevices').checked = false;
        }

        // å…¨é€‰/å–æ¶ˆå…¨é€‰æ–°è®¾å¤‡
        function toggleAllNewDevices(checked) {
            const checkboxes = document.querySelectorAll('.new-device-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = checked;
            });
        }

        // ç¡®è®¤æ·»åŠ è®¾å¤‡
        function confirmAddDevices() {
            const selectedDevices = Array.from(document.querySelectorAll('.new-device-checkbox:checked'))
                .map(cb => cb.value);

            if (selectedDevices.length === 0) {
                showNotification(getTranslation('ruleNotifySelectDeviceFirst'), 'warning');
                return;
            }

            const rule = allRules.find(r => r.id === currentRuleId);
            if (rule) {
                if (!rule.deployedDevices) {
                    rule.deployedDevices = [];
                }

                selectedDevices.forEach(deviceId => {
                    if (!rule.deployedDevices.includes(deviceId)) {
                        rule.deployedDevices.push(deviceId);
                    }
                });

                // åŒæ­¥æ›´æ–°filteredRules
                const filteredRule = filteredRules.find(r => r.id === currentRuleId);
                if (filteredRule) {
                    filteredRule.deployedDevices = rule.deployedDevices;
                }

                showNotification(getTranslation('ruleNotifyDevicesAddedCount').replace('{count}', selectedDevices.length), 'success');
                closeAddDeviceModal();
                renderDeviceList();

                // æ›´æ–°å‰¯æ ‡é¢˜
                const deployedCount = rule.deployedDevices.length;
                document.getElementById('drawerSubtitle').textContent = getTranslation('ruleDrawerSubtitle').replace('{name}', getRuleName(rule)).replace('{count}', deployedCount);
            }
        }

        // ç§»é™¤å·²ä¸‹å‘è®¾å¤‡
        function removeDeployedDevice(deviceId) {
            const rule = allRules.find(r => r.id === currentRuleId);
            if (rule) {
                rule.deployedDevices = rule.deployedDevices.filter(id => id !== deviceId);

                // åŒæ­¥æ›´æ–°filteredRulesä¸­çš„æ•°æ®
                const filteredRule = filteredRules.find(r => r.id === currentRuleId);
                if (filteredRule) {
                    filteredRule.deployedDevices = rule.deployedDevices;
                }

                const device = availableDevices.find(d => d.id === deviceId);
                showNotification(getTranslation('ruleNotifyDeviceRemovedName').replace('{name}', device ? device.name : ''), 'success');
                renderDeviceList();

                // æ›´æ–°å‰¯æ ‡é¢˜
                const deployedCount = rule.deployedDevices.length;
                document.getElementById('drawerSubtitle').textContent = getTranslation('ruleDrawerSubtitle').replace('{name}', getRuleName(rule)).replace('{count}', deployedCount);
            }
        }

        // å…¨é€‰/å–æ¶ˆå…¨é€‰å·²ä¸‹å‘è®¾å¤‡
        function toggleAllDeployedDevices(checked) {
            const checkboxes = document.querySelectorAll('.deployed-device-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = checked;
            });
        }

        // æ‰¹é‡ç§»é™¤å·²ä¸‹å‘è®¾å¤‡
        function batchRemoveDevices() {
            const checkboxes = document.querySelectorAll('.deployed-device-checkbox:checked');
            if (checkboxes.length === 0) {
                showNotification(getTranslation('ruleNotifySelectDeviceToRemove'), 'warning');
                return;
            }

            if (!confirm(getTranslation('ruleNotifyRemoveDevice'))) {
                return;
            }

            const rule = allRules.find(r => r.id === currentRuleId);
            if (rule) {
                const deviceIdsToRemove = Array.from(checkboxes).map(cb => cb.getAttribute('data-device-id'));

                // æ‰¹é‡ç§»é™¤è®¾å¤‡
                rule.deployedDevices = rule.deployedDevices.filter(id => !deviceIdsToRemove.includes(id));

                // åŒæ­¥æ›´æ–°filteredRulesä¸­çš„æ•°æ®
                const filteredRule = filteredRules.find(r => r.id === currentRuleId);
                if (filteredRule) {
                    filteredRule.deployedDevices = rule.deployedDevices;
                }

                showNotification(getTranslation('ruleNotifyDevicesRemovedCount').replace('{count}', deviceIdsToRemove.length), 'success');

                // å–æ¶ˆå…¨é€‰å¤é€‰æ¡†
                document.getElementById('selectAllDeployedDevices').checked = false;

                renderDeviceList();

                // æ›´æ–°å‰¯æ ‡é¢˜
                const deployedCount = rule.deployedDevices.length;
                document.getElementById('drawerSubtitle').textContent = getTranslation('ruleDrawerSubtitle').replace('{name}', getRuleName(rule)).replace('{count}', deployedCount);
            }
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 24px;
                background: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                display: flex;
                align-items: center;
                gap: 12px;
                z-index: 99999;
                animation: slideIn 0.3s ease;
            `;

            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                info: 'fa-info-circle',
                warning: 'fa-exclamation-triangle'
            };

            const colors = {
                success: '#10b981',
                error: '#ef4444',
                info: '#3b82f6',
                warning: '#f59e0b'
            };

            notification.innerHTML = `
                <i class="fas ${icons[type]}" style="color: ${colors[type]}; font-size: 20px;"></i>
                <span style="color: var(--text-primary);">${message}</span>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // ==================== ç­–ç•¥ç±»å‹é€‰æ‹© ====================

        // é€‰æ‹©ç­–ç•¥ç±»å‹
        function selectPolicyType(type) {
            // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.policy-type-card').forEach(card => {
                card.classList.remove('selected');
            });

            // æ·»åŠ é€‰ä¸­çŠ¶æ€
            const selectedCard = document.querySelector(`.policy-type-card[data-type="${type}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }

            // è®¾ç½®éšè—å­—æ®µå€¼
            document.getElementById('ruleType').value = type;

            // æ ¹æ®ç­–ç•¥ç±»å‹è®¾ç½®é€šçŸ¥æ–¹å¼é»˜è®¤å‹¾é€‰
            const inAppCheckbox = document.getElementById('notifyInApp');
            const emailCheckbox = document.getElementById('notifyEmail');
            const smsCheckbox = document.getElementById('notifySms');

            // ç«™å†…ä¿¡å§‹ç»ˆå‹¾é€‰ä¸”ç¦ç”¨
            inAppCheckbox.checked = true;
            inAppCheckbox.disabled = true;

            // æ ¹æ®ä¸åŒç­–ç•¥ç±»å‹è®¾ç½®é»˜è®¤å‹¾é€‰
            if (type === 'fault') {
                // æ•…éšœï¼šç«™å†…ä¿¡ + é‚®ä»¶ + çŸ­ä¿¡ (å…¨éƒ¨å‹¾é€‰)
                emailCheckbox.checked = true;
                smsCheckbox.checked = true;
            } else if (type === 'warning') {
                // å‘Šè­¦ï¼šç«™å†…ä¿¡ + é‚®ä»¶
                emailCheckbox.checked = true;
                smsCheckbox.checked = false;
            } else if (type === 'notice') {
                // é€šçŸ¥ï¼šä»…ç«™å†…ä¿¡
                emailCheckbox.checked = false;
                smsCheckbox.checked = false;
            }
        }

        // ==================== é€šçŸ¥è®¾ç½®é¢æ¿æ§åˆ¶å‡½æ•° ====================

        // æ‰“å¼€é€šçŸ¥è®¾ç½®é¢æ¿
        function openNotificationPanel() {
            const overlay = document.getElementById('notificationPanelOverlay');
            const panel = document.getElementById('notificationPanel');

            overlay.classList.add('show');
            // å»¶è¿Ÿæ·»åŠ showç±»ä»¥è§¦å‘åŠ¨ç”»
            setTimeout(() => {
                panel.classList.add('show');
            }, 10);
        }

        // å…³é—­é€šçŸ¥è®¾ç½®é¢æ¿
        function closeNotificationPanel() {
            const overlay = document.getElementById('notificationPanelOverlay');
            const panel = document.getElementById('notificationPanel');

            panel.classList.remove('show');
            // ç­‰å¾…åŠ¨ç”»å®Œæˆåç§»é™¤overlay
            setTimeout(() => {
                overlay.classList.remove('show');
            }, 300);
        }

        // ä¿å­˜é€šçŸ¥è®¾ç½®
        function saveNotificationSettings() {
            // æ”¶é›†é€šçŸ¥ç±»å‹é…ç½®ï¼ˆåŒ…å«æ¯ä¸ªç±»å‹çš„ç‹¬ç«‹é™å™ªè®¾ç½®ï¼‰
            const levelPolicies = {
                critical: {
                    enabled: document.getElementById('criticalEnabled').checked,
                    channels: {
                        sms: document.getElementById('criticalSms').checked,
                        email: document.getElementById('criticalEmail').checked
                    },
                    noiseReduction: {
                        enabled: document.getElementById('criticalNoiseEnabled').checked,
                        repeatInterval: parseInt(document.getElementById('criticalRepeatInterval').value),
                        maxRepeats: parseInt(document.getElementById('criticalMaxRepeats').value)
                    }
                },
                important: {
                    enabled: document.getElementById('importantEnabled').checked,
                    channels: {
                        sms: document.getElementById('importantSms').checked,
                        email: document.getElementById('importantEmail').checked
                    },
                    noiseReduction: {
                        enabled: document.getElementById('importantNoiseEnabled').checked,
                        repeatInterval: parseInt(document.getElementById('importantRepeatInterval').value),
                        maxRepeats: parseInt(document.getElementById('importantMaxRepeats').value)
                    }
                },
                general: {
                    enabled: document.getElementById('generalEnabled').checked,
                    channels: {
                        sms: document.getElementById('generalSms').checked,
                        email: document.getElementById('generalEmail').checked
                    },
                    noiseReduction: {
                        enabled: document.getElementById('generalNoiseEnabled').checked,
                        repeatInterval: parseInt(document.getElementById('generalRepeatInterval').value),
                        maxRepeats: parseInt(document.getElementById('generalMaxRepeats').value)
                    }
                }
            };

            const settings = {
                levelPolicies: levelPolicies
            };

            console.log('ä¿å­˜é€šçŸ¥ç­–ç•¥è®¾ç½®:', settings);

            // æ˜¾ç¤ºæˆåŠŸæç¤º
            showNotification(getTranslation('ruleNotifySettingsSaved'), 'success');

            // å…³é—­é¢æ¿
            closeNotificationPanel();
        }

        // å±•å¼€/æ”¶èµ·é€šçŸ¥ç±»å‹é…ç½®
        function toggleAlarmLevel(level) {
            const content = document.getElementById(level + 'Content');
            const chevron = document.getElementById(level + 'Chevron');

            if (content.style.maxHeight === '0px') {
                // å±•å¼€
                content.style.maxHeight = '500px';
                content.style.opacity = '1';
                content.style.padding = '16px';
                content.style.borderWidth = '1px';
                chevron.style.transform = 'rotate(0deg)';
            } else {
                // æ”¶èµ·
                content.style.maxHeight = '0px';
                content.style.opacity = '0';
                content.style.padding = '0';
                content.style.borderWidth = '0';
                chevron.style.transform = 'rotate(-90deg)';
            }
        }

        // åˆ‡æ¢é™å™ªé…ç½®æ˜¾ç¤º/éšè—
        function toggleNoiseConfig(level, enabled) {
            const config = document.getElementById(level + 'NoiseConfig');

            if (enabled) {
                // æ˜¾ç¤ºé™å™ªé…ç½®
                config.style.maxHeight = '100px';
                config.style.opacity = '1';
                config.style.marginTop = '0';
            } else {
                // éšè—é™å™ªé…ç½®
                config.style.maxHeight = '0';
                config.style.opacity = '0';
                config.style.marginTop = '0';
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();

            // âœ… é¢„åŠ è½½è®¾å¤‡å±æ€§(ç¡®ä¿é¡µé¢åˆå§‹åŒ–æ—¶å±æ€§å·²å¯ç”¨)
            loadDeviceAttributes();
            console.log('ğŸ“¦ é¡µé¢åˆå§‹åŒ–å®Œæˆï¼Œè®¾å¤‡å±æ€§å·²é¢„åŠ è½½');

            // æ£€æµ‹URLå‚æ•°ï¼Œå¦‚æœéœ€è¦æ‰“å¼€é€šçŸ¥è®¾ç½®é¢æ¿
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('openNotificationPanel') === 'true') {
                // å»¶è¿Ÿä¸€å°æ®µæ—¶é—´ç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½
                setTimeout(() => {
                    openNotificationPanel();
                }, 300);
            }
        });

        // ç›‘å¬è¯­è¨€åˆ‡æ¢äº‹ä»¶
        window.addEventListener('languageChanged', function() {
            // é‡æ–°æ¸²æŸ“è§„åˆ™è¡¨æ ¼
            renderRulesTable();
            // æ›´æ–°ç»Ÿè®¡æ•°æ®æ˜¾ç¤º
            updateStats();
        });
    </script>
</body>
</html>
