<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="exportPageTitle">数据导出 - 储能柜管理系统</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="common.js"></script>
    <style>
        /* ==================== 全局重置 ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            min-height: 100vh;
            padding: 0;
        }

        /* ==================== 顶部导航栏 ==================== */
        .top-bar {
            background: white;
            padding: 16px 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .page-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 600;
            color: #1e293b;
        }

        .page-title i {
            color: #2196f3;
            font-size: 24px;
        }

        .back-btn {
            padding: 8px 16px;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            color: #64748b;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .back-btn:hover {
            background: #e9ecef;
            border-color: #cbd5e0;
        }

        /* ==================== 主内容区 ==================== */
        .main-content {
            padding: 24px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .export-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            margin-bottom: 24px;
        }

        /* ==================== 时间选择区域 ==================== */
        .time-section {
            padding: 24px;
            border-bottom: 1px solid #e5e7eb;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title i {
            color: #2196f3;
        }

        .date-range-selector {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: nowrap;
        }

        .date-input {
            height: 40px;
            padding: 0 16px;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            color: #333;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            width: 200px;
        }

        .date-input:hover {
            border-color: #2196f3;
        }

        .date-input:focus {
            outline: none;
            border-color: #2196f3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .date-separator {
            color: #64748b;
            font-size: 14px;
        }

        /* ==================== 组件选择区域 ==================== */
        .component-section {
            padding: 24px;
            border-bottom: 1px solid #e5e7eb;
        }

        .component-selector {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .component-select {
            width: 300px;
            height: 40px;
            padding: 0 16px;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            color: #333;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .component-select:hover {
            border-color: #2196f3;
        }

        .component-select:focus {
            outline: none;
            border-color: #2196f3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        /* ==================== 指标选择区域 ==================== */
        .indicators-section {
            padding: 24px;
        }

        .indicator-groups {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 16px;
        }

        .indicator-group {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }

        .group-header {
            background: #f8f9fa;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
        }

        .group-header:hover {
            background: #e9ecef;
        }

        .group-title {
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .group-title i {
            color: #2196f3;
        }

        .group-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .select-all-btn {
            font-size: 12px;
            color: #2196f3;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .select-all-btn:hover {
            background: rgba(33, 150, 243, 0.1);
        }

        .expand-icon {
            color: #64748b;
            font-size: 12px;
            transition: transform 0.3s;
        }

        .group-header.collapsed .expand-icon {
            transform: rotate(-90deg);
        }

        .group-content {
            padding: 16px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            background: white;
        }

        .group-content.collapsed {
            display: none;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .checkbox-item:hover {
            background: #f8f9fa;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #2196f3;
        }

        .checkbox-item label {
            font-size: 14px;
            color: #475569;
            cursor: pointer;
            flex: 1;
        }

        /* ==================== 底部操作栏 ==================== */
        .action-bar {
            padding: 20px 24px;
            background: #f8f9fa;
            border-top: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }

        .selection-info {
            font-size: 14px;
            color: #64748b;
        }

        .selection-count {
            color: #2196f3;
            font-weight: 600;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
        }

        .btn {
            height: 40px;
            padding: 0 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #2196f3;
            color: white;
        }

        .btn-primary:hover {
            background: #1976d2;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        }

        .btn-primary:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            box-shadow: none;
        }

        .btn-secondary {
            background: white;
            color: #64748b;
            border: 1px solid #e0e0e0;
        }

        .btn-secondary:hover {
            background: #f8f9fa;
            border-color: #cbd5e0;
        }

        /* ==================== 数据表格区域 ==================== */
        .data-table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            display: none;
        }

        .data-table-container.show {
            display: block;
        }

        .table-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .table-title {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .table-title i {
            color: #2196f3;
        }

        .data-count {
            font-size: 14px;
            color: #64748b;
            margin-left: 12px;
        }

        .export-btn {
            background: #4caf50;
            color: white;
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .export-btn:hover {
            background: #45a049;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .table-wrapper {
            overflow-x: auto;
            max-height: 600px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table thead {
            position: sticky;
            top: 0;
            background: #f8f9fa;
            z-index: 10;
        }

        .data-table th {
            padding: 12px 16px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: #1e293b;
            border-bottom: 2px solid #e5e7eb;
            white-space: nowrap;
        }

        .data-table td {
            padding: 12px 16px;
            font-size: 13px;
            color: #475569;
            border-bottom: 1px solid #f1f5f9;
            white-space: nowrap;
        }

        .data-table tbody tr:hover {
            background: #f8f9fa;
        }

        /* 空状态 */
        .empty-data {
            text-align: center;
            padding: 60px 20px;
            color: #94a3b8;
        }

        .empty-data i {
            font-size: 48px;
            margin-bottom: 16px;
            color: #cbd5e0;
        }

        .empty-data-text {
            font-size: 16px;
            margin-bottom: 8px;
        }

        .empty-data-hint {
            font-size: 14px;
            color: #cbd5e0;
        }

        /* ==================== 通知提示 ==================== */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 9999;
            animation: slideIn 0.3s ease;
            border-left: 4px solid;
        }

        .notification.success {
            border-left-color: #4caf50;
        }

        .notification.warning {
            border-left-color: #ff9800;
        }

        .notification.error {
            border-left-color: #f44336;
        }

        .notification.info {
            border-left-color: #2196f3;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ==================== 加载状态 ==================== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-content {
            background: white;
            border-radius: 12px;
            padding: 32px 48px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #e0e0e0;
            border-top-color: #2196f3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: #1e293b;
            font-size: 14px;
        }

        /* ==================== 响应式设计 ==================== */
        @media (max-width: 768px) {
            .main-content {
                padding: 16px;
            }

            .date-range-selector {
                flex-direction: column;
                align-items: stretch;
            }

            .date-input {
                width: 100%;
            }

            .component-select {
                width: 100%;
            }

            .indicator-groups {
                grid-template-columns: 1fr;
            }

            .action-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .table-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <div class="top-bar">
        <div class="page-title">
            <i class="fas fa-download"></i>
            <span id="exportTitle">数据导出</span>
        </div>
        <button class="back-btn" onclick="goBack()">
            <i class="fas fa-arrow-left"></i>
            <span id="exportBtnBack">返回</span>
        </button>
    </div>

    <!-- 主内容区 -->
    <div class="main-content">
        <!-- 查询条件区 -->
        <div class="export-container">
            <!-- 时间选择区域 -->
            <div class="time-section">
                <div class="section-title">
                    <i class="fas fa-calendar-alt"></i>
                    <span id="exportSelectTimeRange">选择时间范围</span>
                </div>
                <div class="date-range-selector">
                    <input type="text" class="date-input" id="startDate" data-translate-placeholder="exportStartTime" placeholder="开始时间" readonly>
                    <span class="date-separator">至</span>
                    <input type="text" class="date-input" id="endDate" data-translate-placeholder="exportEndTime" placeholder="结束时间" readonly>
                    <span class="date-separator" style="margin-left: 16px;" id="exportGranularity">颗粒度</span>
                    <select class="date-input" id="intervalSelect" style="width: 120px;">
                        <option value="5" data-translate="exportGranularity5min">5分钟</option>
                        <option value="15" data-translate="exportGranularity15min">15分钟</option>
                        <option value="30" data-translate="exportGranularity30min">30分钟</option>
                        <option value="60" data-translate="exportGranularity1hour">1小时</option>
                        <option value="1440" data-translate="exportGranularity1day">1天</option>
                    </select>
                </div>
            </div>

            <!-- 组件选择区域 -->
            <div class="component-section">
                <div class="section-title">
                    <i class="fas fa-cube"></i>
                    <span id="exportSelectComponent">选择组件类型</span>
                </div>
                <div class="component-selector">
                    <select class="component-select" id="componentSelect" onchange="handleComponentChange()">
                        <option value="overall" data-translate="exportComponentOverall">整机</option>
                        <option value="ems">EMS</option>
                        <option value="inverter" data-translate="exportComponentInverter">逆变器</option>
                        <option value="bms">BMS</option>
                        <option value="meter" data-translate="exportComponentMeter">电表</option>
                        <option value="thermal" data-translate="exportComponentThermal">热管理</option>
                        <option value="fire" data-translate="exportComponentFire">消防</option>
                    </select>
                </div>
            </div>

            <!-- 指标选择区域 -->
            <div class="indicators-section">
                <div class="section-title">
                    <i class="fas fa-check-square"></i>
                    <span id="exportSelectIndicators">选择查询指标</span>
                </div>
                <div class="indicator-groups" id="indicatorGroups">
                    <!-- 动态生成指标组 -->
                </div>
            </div>

            <!-- 底部操作栏 -->
            <div class="action-bar">
                <div class="selection-info">
                    <span id="exportSelectedIndicators">已选择</span> <span class="selection-count" id="selectionCount">0</span> <span id="exportIndicatorsUnit">项指标</span>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="resetSelection()">
                        <i class="fas fa-undo"></i>
                        <span id="exportBtnReset">重置</span>
                    </button>
                    <button class="btn btn-primary" id="queryBtn" onclick="handleQuery()" disabled>
                        <i class="fas fa-search"></i>
                        <span id="exportBtnQuery">查询</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- 数据表格区域 -->
        <div class="data-table-container" id="dataTableContainer">
            <div class="table-header">
                <div>
                    <span class="table-title">
                        <i class="fas fa-table"></i>
                        <span id="exportQueryResult">查询结果</span>
                    </span>
                    <span class="data-count" id="dataCount"><span id="exportTotalData">共</span> 0 <span id="exportDataUnit">条数据</span></span>
                </div>
                <button class="export-btn" onclick="handleExport()">
                    <i class="fas fa-download"></i>
                    <span id="exportBtnExport">导出数据</span>
                </button>
            </div>
            <div class="table-wrapper">
                <table class="data-table" id="dataTable">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 加载状态 -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text" id="exportLoading">正在查询数据...</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh.js"></script>
    <script>
        // ==================== 各组件指标配置 ====================
        const componentIndicatorConfigs = {
            // 整机指标 - 系统级综合数据
            overall: {
                '基础信息': [
                    { id: 'timestamp', label: '时间戳', checked: true },
                    { id: 'cabinetId', label: '储能柜ID', checked: true },
                    { id: 'systemStatus', label: '系统状态', checked: true },
                    { id: 'operationMode', label: '运行模式', checked: true }
                ],
                '功率数据': [
                    { id: 'activePower', label: '有功功率 (kW)', checked: true },
                    { id: 'reactivePower', label: '无功功率 (kVar)', checked: false },
                    { id: 'apparentPower', label: '视在功率 (kVA)', checked: false },
                    { id: 'powerFactor', label: '功率因数', checked: false }
                ],
                '电池状态': [
                    { id: 'soc', label: 'SOC (%)', checked: true },
                    { id: 'soh', label: 'SOH (%)', checked: true },
                    { id: 'batteryVoltage', label: '电池电压 (V)', checked: true },
                    { id: 'batteryCurrent', label: '电池电流 (A)', checked: true },
                    { id: 'batteryTemp', label: '电池温度 (°C)', checked: true }
                ],
                '能量统计': [
                    { id: 'todayCharge', label: '今日充电量 (kWh)', checked: false },
                    { id: 'todayDischarge', label: '今日放电量 (kWh)', checked: false },
                    { id: 'totalChargeEnergy', label: '累计充电量 (MWh)', checked: false },
                    { id: 'totalDischargeEnergy', label: '累计放电量 (MWh)', checked: false }
                ]
            },
            // EMS指标 - 能量管理系统
            ems: {
                '基础信息': [
                    { id: 'timestamp', label: '时间戳', checked: true },
                    { id: 'emsId', label: 'EMS设备ID', checked: true },
                    { id: 'emsStatus', label: 'EMS运行状态', checked: true },
                    { id: 'commStatus', label: '通信状态', checked: true }
                ],
                '调度指令': [
                    { id: 'dispatchMode', label: '调度模式', checked: true },
                    { id: 'targetPower', label: '目标功率 (kW)', checked: true },
                    { id: 'targetSOC', label: '目标SOC (%)', checked: true },
                    { id: 'powerLimit', label: '功率限制 (kW)', checked: false }
                ],
                '功率控制': [
                    { id: 'chargePower', label: '充电功率 (kW)', checked: true },
                    { id: 'dischargePower', label: '放电功率 (kW)', checked: true },
                    { id: 'gridPower', label: '电网功率 (kW)', checked: true },
                    { id: 'pvPower', label: '光伏功率 (kW)', checked: false },
                    { id: 'loadPower', label: '负载功率 (kW)', checked: false }
                ],
                '运行策略': [
                    { id: 'controlStrategy', label: '控制策略', checked: false },
                    { id: 'peakShavingStatus', label: '削峰填谷状态', checked: false },
                    { id: 'demandResponse', label: '需求响应', checked: false },
                    { id: 'frequencyRegulation', label: '调频服务', checked: false }
                ],
                '经济数据': [
                    { id: 'electricityPrice', label: '当前电价 (元/kWh)', checked: false },
                    { id: 'todayRevenue', label: '今日收益 (元)', checked: false },
                    { id: 'totalRevenue', label: '累计收益 (元)', checked: false }
                ]
            },
            // 逆变器/PCS指标 - 功率转换系统
            inverter: {
                '基础信息': [
                    { id: 'timestamp', label: '时间戳', checked: true },
                    { id: 'pcsId', label: 'PCS设备ID', checked: true },
                    { id: 'pcsStatus', label: 'PCS运行状态', checked: true },
                    { id: 'faultCode', label: '故障代码', checked: false }
                ],
                '直流侧参数': [
                    { id: 'dcVoltage', label: 'DC电压 (V)', checked: true },
                    { id: 'dcCurrent', label: 'DC电流 (A)', checked: true },
                    { id: 'dcPower', label: 'DC功率 (kW)', checked: true }
                ],
                '交流侧参数': [
                    { id: 'acVoltageA', label: 'AC电压-A相 (V)', checked: true },
                    { id: 'acVoltageB', label: 'AC电压-B相 (V)', checked: false },
                    { id: 'acVoltageC', label: 'AC电压-C相 (V)', checked: false },
                    { id: 'acCurrentA', label: 'AC电流-A相 (A)', checked: true },
                    { id: 'acCurrentB', label: 'AC电流-B相 (A)', checked: false },
                    { id: 'acCurrentC', label: 'AC电流-C相 (A)', checked: false },
                    { id: 'frequency', label: '频率 (Hz)', checked: true }
                ],
                '功率参数': [
                    { id: 'activePower', label: '有功功率 (kW)', checked: true },
                    { id: 'reactivePower', label: '无功功率 (kVar)', checked: true },
                    { id: 'apparentPower', label: '视在功率 (kVA)', checked: false },
                    { id: 'powerFactor', label: '功率因数', checked: true }
                ],
                '性能与保护': [
                    { id: 'efficiency', label: '转换效率 (%)', checked: false },
                    { id: 'igbtTemp', label: 'IGBT温度 (°C)', checked: true },
                    { id: 'inductorTemp', label: '电感温度 (°C)', checked: false },
                    { id: 'ambientTemp', label: '环境温度 (°C)', checked: false }
                ]
            },
            // BMS指标 - 电池管理系统
            bms: {
                '基础信息': [
                    { id: 'timestamp', label: '时间戳', checked: true },
                    { id: 'bmsId', label: 'BMS设备ID', checked: true },
                    { id: 'bmsStatus', label: 'BMS运行状态', checked: true },
                    { id: 'faultLevel', label: '故障等级', checked: true }
                ],
                '整体电气参数': [
                    { id: 'totalVoltage', label: '总电压 (V)', checked: true },
                    { id: 'totalCurrent', label: '总电流 (A)', checked: true },
                    { id: 'soc', label: 'SOC (%)', checked: true },
                    { id: 'soh', label: 'SOH (%)', checked: true },
                    { id: 'cycleCount', label: '循环次数', checked: false },
                    { id: 'remainCapacity', label: '剩余容量 (Ah)', checked: false }
                ],
                '单体电压': [
                    { id: 'maxCellVoltage', label: '最高单体电压 (V)', checked: true },
                    { id: 'minCellVoltage', label: '最低单体电压 (V)', checked: true },
                    { id: 'avgCellVoltage', label: '平均单体电压 (V)', checked: false },
                    { id: 'voltageDiff', label: '压差 (mV)', checked: true },
                    { id: 'maxCellNum', label: '最高电压单体号', checked: false },
                    { id: 'minCellNum', label: '最低电压单体号', checked: false }
                ],
                '温度监测': [
                    { id: 'maxTemp', label: '最高温度 (°C)', checked: true },
                    { id: 'minTemp', label: '最低温度 (°C)', checked: true },
                    { id: 'avgTemp', label: '平均温度 (°C)', checked: true },
                    { id: 'tempDiff', label: '温差 (°C)', checked: true },
                    { id: 'maxTempNum', label: '最高温度探头号', checked: false },
                    { id: 'minTempNum', label: '最低温度探头号', checked: false }
                ],
                'Pack簇信息': [
                    { id: 'packCount', label: 'Pack簇数量', checked: false },
                    { id: 'pack1Voltage', label: 'Pack1电压 (V)', checked: false },
                    { id: 'pack1Current', label: 'Pack1电流 (A)', checked: false },
                    { id: 'pack1Soc', label: 'Pack1 SOC (%)', checked: false },
                    { id: 'pack1MaxTemp', label: 'Pack1最高温度 (°C)', checked: false }
                ],
                '保护状态': [
                    { id: 'chargeOverVoltage', label: '充电过压保护', checked: false },
                    { id: 'dischargeUnderVoltage', label: '放电欠压保护', checked: false },
                    { id: 'chargeOverCurrent', label: '充电过流保护', checked: false },
                    { id: 'dischargeOverCurrent', label: '放电过流保护', checked: false },
                    { id: 'overTemp', label: '过温保护', checked: false },
                    { id: 'underTemp', label: '低温保护', checked: false }
                ]
            },
            // 电表指标 - 电网侧计量
            meter: {
                '基础信息': [
                    { id: 'timestamp', label: '时间戳', checked: true },
                    { id: 'meterId', label: '电表设备ID', checked: true },
                    { id: 'meterType', label: '电表类型', checked: false }
                ],
                '三相电压': [
                    { id: 'voltageA', label: 'A相电压 (V)', checked: true },
                    { id: 'voltageB', label: 'B相电压 (V)', checked: true },
                    { id: 'voltageC', label: 'C相电压 (V)', checked: true },
                    { id: 'voltageAB', label: 'AB线电压 (V)', checked: false },
                    { id: 'voltageBC', label: 'BC线电压 (V)', checked: false },
                    { id: 'voltageCA', label: 'CA线电压 (V)', checked: false }
                ],
                '三相电流': [
                    { id: 'currentA', label: 'A相电流 (A)', checked: true },
                    { id: 'currentB', label: 'B相电流 (A)', checked: true },
                    { id: 'currentC', label: 'C相电流 (A)', checked: true },
                    { id: 'currentN', label: '零线电流 (A)', checked: false }
                ],
                '功率数据': [
                    { id: 'totalActivePower', label: '总有功功率 (kW)', checked: true },
                    { id: 'totalReactivePower', label: '总无功功率 (kVar)', checked: false },
                    { id: 'totalApparentPower', label: '总视在功率 (kVA)', checked: false },
                    { id: 'activePowerA', label: 'A相有功功率 (kW)', checked: false },
                    { id: 'activePowerB', label: 'B相有功功率 (kW)', checked: false },
                    { id: 'activePowerC', label: 'C相有功功率 (kW)', checked: false }
                ],
                '电能数据': [
                    { id: 'positiveActiveEnergy', label: '正向有功总电能 (kWh)', checked: true },
                    { id: 'reverseActiveEnergy', label: '反向有功总电能 (kWh)', checked: true },
                    { id: 'positiveReactiveEnergy', label: '正向无功总电能 (kVarh)', checked: false },
                    { id: 'reverseReactiveEnergy', label: '反向无功总电能 (kVarh)', checked: false }
                ],
                '电能质量': [
                    { id: 'frequency', label: '频率 (Hz)', checked: true },
                    { id: 'totalPowerFactor', label: '总功率因数', checked: true },
                    { id: 'powerFactorA', label: 'A相功率因数', checked: false },
                    { id: 'powerFactorB', label: 'B相功率因数', checked: false },
                    { id: 'powerFactorC', label: 'C相功率因数', checked: false },
                    { id: 'voltageUnbalance', label: '电压不平衡度 (%)', checked: false },
                    { id: 'currentUnbalance', label: '电流不平衡度 (%)', checked: false }
                ]
            },
            // 热管理指标 - 温控与热管理系统
            thermal: {
                '基础信息': [
                    { id: 'timestamp', label: '时间戳', checked: true },
                    { id: 'thermalSystemId', label: '热管理系统ID', checked: true },
                    { id: 'thermalStatus', label: '热管理状态', checked: true }
                ],
                '环境温度': [
                    { id: 'outdoorTemp', label: '室外温度 (°C)', checked: true },
                    { id: 'indoorTemp', label: '柜内温度 (°C)', checked: true },
                    { id: 'cabinetInletTemp', label: '进风口温度 (°C)', checked: true },
                    { id: 'cabinetOutletTemp', label: '出风口温度 (°C)', checked: true }
                ],
                '电池热状态': [
                    { id: 'batteryMaxTemp', label: '电池最高温度 (°C)', checked: true },
                    { id: 'batteryMinTemp', label: '电池最低温度 (°C)', checked: true },
                    { id: 'batteryAvgTemp', label: '电池平均温度 (°C)', checked: true },
                    { id: 'batteryTempDiff', label: '电池温差 (°C)', checked: true }
                ],
                '制冷系统': [
                    { id: 'coolingMode', label: '制冷模式', checked: true },
                    { id: 'coolingStatus', label: '制冷状态', checked: true },
                    { id: 'coolingPower', label: '制冷功率 (kW)', checked: false },
                    { id: 'compressorStatus', label: '压缩机状态', checked: false },
                    { id: 'refrigerantPressure', label: '冷媒压力 (MPa)', checked: false }
                ],
                '加热系统': [
                    { id: 'heatingMode', label: '加热模式', checked: true },
                    { id: 'heatingStatus', label: '加热状态', checked: true },
                    { id: 'heatingPower', label: '加热功率 (kW)', checked: false },
                    { id: 'heaterTemp', label: '加热器温度 (°C)', checked: false }
                ],
                '风机系统': [
                    { id: 'fanStatus', label: '风机状态', checked: true },
                    { id: 'fanSpeed', label: '风机转速 (rpm)', checked: true },
                    { id: 'fanPower', label: '风机功率 (W)', checked: false },
                    { id: 'airFlowRate', label: '风量 (m³/h)', checked: false }
                ],
                '液冷系统': [
                    { id: 'liquidCoolingStatus', label: '液冷状态', checked: false },
                    { id: 'coolantTemp', label: '冷却液温度 (°C)', checked: false },
                    { id: 'coolantFlowRate', label: '冷却液流量 (L/min)', checked: false },
                    { id: 'coolantPressure', label: '冷却液压力 (kPa)', checked: false }
                ],
                '热管理能耗': [
                    { id: 'totalThermalPower', label: '热管理总功率 (kW)', checked: false },
                    { id: 'thermalEnergyConsumption', label: '热管理能耗 (kWh)', checked: false },
                    { id: 'thermalEfficiency', label: '热管理效率 (%)', checked: false }
                ]
            },
            // 消防指标 - 消防安全系统
            fire: {
                '基础信息': [
                    { id: 'timestamp', label: '时间戳', checked: true },
                    { id: 'fireSystemId', label: '消防系统ID', checked: true },
                    { id: 'systemStatus', label: '系统运行状态', checked: true },
                    { id: 'selfCheckStatus', label: '自检状态', checked: false }
                ],
                '烟感探测': [
                    { id: 'smokeDetector1', label: '1号烟感探测器', checked: true },
                    { id: 'smokeDetector2', label: '2号烟感探测器', checked: true },
                    { id: 'smokeDetector3', label: '3号烟感探测器', checked: false },
                    { id: 'smokeConcentration', label: '烟雾浓度 (ppm)', checked: true }
                ],
                '温感探测': [
                    { id: 'tempDetector1', label: '1号温感探测器 (°C)', checked: true },
                    { id: 'tempDetector2', label: '2号温感探测器 (°C)', checked: true },
                    { id: 'tempDetector3', label: '3号温感探测器 (°C)', checked: false },
                    { id: 'tempRiseRate', label: '温升速率 (°C/min)', checked: false }
                ],
                '气体监测': [
                    { id: 'h2Concentration', label: 'H₂浓度 (ppm)', checked: true },
                    { id: 'coConcentration', label: 'CO浓度 (ppm)', checked: false },
                    { id: 'co2Concentration', label: 'CO₂浓度 (ppm)', checked: false },
                    { id: 'gasAlarmLevel', label: '气体告警等级', checked: true }
                ],
                '告警信息': [
                    { id: 'fireAlarmStatus', label: '火灾报警状态', checked: true },
                    { id: 'alarmLevel', label: '告警级别', checked: true },
                    { id: 'alarmType', label: '告警类型', checked: true },
                    { id: 'alarmPosition', label: '告警位置', checked: false }
                ],
                '灭火系统': [
                    { id: 'extinguishingMode', label: '灭火模式', checked: false },
                    { id: 'sprayStatus', label: '喷淋状态', checked: true },
                    { id: 'gasExtinguisherStatus', label: '气体灭火状态', checked: false },
                    { id: 'extinguisherPressure', label: '灭火剂压力 (MPa)', checked: true },
                    { id: 'extinguisherWeight', label: '灭火剂重量 (kg)', checked: false },
                    { id: 'nozzleStatus', label: '喷头状态', checked: false }
                ],
                '联动控制': [
                    { id: 'emergencyStop', label: '紧急停机', checked: false },
                    { id: 'powerCutoff', label: '电源切断', checked: false },
                    { id: 'ventilationStatus', label: '通风系统状态', checked: false },
                    { id: 'doorLockStatus', label: '门禁状态', checked: false }
                ]
            }
        };

        // ==================== 全局变量 ====================
        let startDatePicker, endDatePicker;
        let selectedIndicators = new Set();
        let currentData = [];
        let currentComponent = 'overall'; // 当前选中的组件

        // ==================== 指标翻译映射 ====================
        // 分组名称翻译映射
        const groupNameTranslations = {
            '基础信息': 'exportGroupBasicInfo',
            '功率数据': 'exportGroupPowerData',
            '电池状态': 'exportGroupBatteryStatus',
            '能量统计': 'exportGroupEnergyStats',
            '调度指令': 'exportGroupDispatchCmd',
            '功率控制': 'exportGroupPowerControl',
            '运行策略': 'exportGroupOperationStrategy',
            '经济数据': 'exportGroupEconomicData',
            '直流侧参数': 'exportGroupDCSide',
            '交流侧参数': 'exportGroupACSide',
            '功率参数': 'exportGroupPowerParams',
            '性能与保护': 'exportGroupPerformanceProtection',
            '整体电气参数': 'exportGroupElectricalParams',
            '单体电压': 'exportGroupCellVoltage',
            '温度监测': 'exportGroupTempMonitor',
            'Pack簇信息': 'exportGroupPackInfo',
            '保护状态': 'exportGroupProtectionStatus',
            '三相电压': 'exportGroupThreePhaseVoltage',
            '三相电流': 'exportGroupThreePhaseCurrent',
            '电能数据': 'exportGroupEnergyData',
            '电能质量': 'exportGroupPowerQuality',
            '环境温度': 'exportGroupEnvironmentTemp',
            '电池热状态': 'exportGroupBatteryThermal',
            '制冷系统': 'exportGroupCoolingSystem',
            '加热系统': 'exportGroupHeatingSystem',
            '风机系统': 'exportGroupFanSystem',
            '液冷系统': 'exportGroupLiquidCooling',
            '热管理能耗': 'exportGroupThermalEnergy',
            '烟感探测': 'exportGroupSmokeDetection',
            '温感探测': 'exportGroupTempDetection',
            '气体监测': 'exportGroupGasMonitor',
            '告警信息': 'exportGroupAlarmInfo',
            '灭火系统': 'exportGroupExtinguishingSystem',
            '联动控制': 'exportGroupLinkageControl'
        };

        // 指标标签翻译映射
        const indicatorLabelTranslations = {
            '时间戳': 'exportTimestamp',
            '储能柜ID': 'exportCabinetId',
            '系统状态': 'exportSystemStatus',
            '运行模式': 'exportOperationMode',
            '有功功率 (kW)': 'exportActivePower',
            '无功功率 (kVar)': 'exportReactivePower',
            '视在功率 (kVA)': 'exportApparentPower',
            '功率因数': 'exportPowerFactor',
            'SOC (%)': 'exportSOC',
            'SOH (%)': 'exportSOH',
            '电池电压 (V)': 'exportBatteryVoltage',
            '电池电流 (A)': 'exportBatteryCurrent',
            '电池温度 (°C)': 'exportBatteryTemp',
            '今日充电量 (kWh)': 'exportTodayCharge',
            '今日放电量 (kWh)': 'exportTodayDischarge',
            '累计充电量 (MWh)': 'exportTotalChargeEnergy',
            '累计放电量 (MWh)': 'exportTotalDischargeEnergy',
            'EMS设备ID': 'exportEmsId',
            'EMS运行状态': 'exportEmsStatus',
            '通信状态': 'exportCommStatus',
            '调度模式': 'exportDispatchMode',
            '目标功率 (kW)': 'exportTargetPower',
            '目标SOC (%)': 'exportTargetSOC',
            '功率限制 (kW)': 'exportPowerLimit',
            '充电功率 (kW)': 'exportChargePower',
            '放电功率 (kW)': 'exportDischargePower',
            '电网功率 (kW)': 'exportGridPower',
            '光伏功率 (kW)': 'exportPvPower',
            '负载功率 (kW)': 'exportLoadPower',
            '控制策略': 'exportControlStrategy',
            '削峰填谷状态': 'exportPeakShavingStatus',
            '需求响应': 'exportDemandResponse',
            '调频服务': 'exportFrequencyRegulation',
            '当前电价 (元/kWh)': 'exportElectricityPrice',
            '今日收益 (元)': 'exportTodayRevenue',
            '累计收益 (元)': 'exportTotalRevenue',
            'PCS设备ID': 'exportPcsId',
            'PCS运行状态': 'exportPcsStatus',
            '故障代码': 'exportFaultCode',
            'DC电压 (V)': 'exportDcVoltage',
            'DC电流 (A)': 'exportDcCurrent',
            'DC功率 (kW)': 'exportDcPower',
            'AC电压-A相 (V)': 'exportAcVoltageA',
            'AC电压-B相 (V)': 'exportAcVoltageB',
            'AC电压-C相 (V)': 'exportAcVoltageC',
            'AC电流-A相 (A)': 'exportAcCurrentA',
            'AC电流-B相 (A)': 'exportAcCurrentB',
            'AC电流-C相 (A)': 'exportAcCurrentC',
            '频率 (Hz)': 'exportFrequency',
            '转换效率 (%)': 'exportEfficiency',
            'IGBT温度 (°C)': 'exportIgbtTemp',
            '电感温度 (°C)': 'exportInductorTemp',
            '环境温度 (°C)': 'exportAmbientTemp',
            'BMS设备ID': 'exportBmsId',
            'BMS运行状态': 'exportBmsStatus',
            '故障等级': 'exportFaultLevel',
            '总电压 (V)': 'exportTotalVoltage',
            '总电流 (A)': 'exportTotalCurrent',
            '循环次数': 'exportCycleCount',
            '剩余容量 (Ah)': 'exportRemainCapacity',
            '最高单体电压 (V)': 'exportMaxCellVoltage',
            '最低单体电压 (V)': 'exportMinCellVoltage',
            '平均单体电压 (V)': 'exportAvgCellVoltage',
            '压差 (mV)': 'exportVoltageDiff',
            '最高电压单体号': 'exportMaxCellNum',
            '最低电压单体号': 'exportMinCellNum',
            '最高温度 (°C)': 'exportMaxTemp',
            '最低温度 (°C)': 'exportMinTemp',
            '平均温度 (°C)': 'exportAvgTemp',
            '温差 (°C)': 'exportTempDiff',
            '最高温度探头号': 'exportMaxTempNum',
            '最低温度探头号': 'exportMinTempNum',
            'Pack簇数量': 'exportPackCount',
            'Pack1电压 (V)': 'exportPack1Voltage',
            'Pack1电流 (A)': 'exportPack1Current',
            'Pack1 SOC (%)': 'exportPack1Soc',
            'Pack1最高温度 (°C)': 'exportPack1MaxTemp',
            '充电过压保护': 'exportChargeOverVoltage',
            '放电欠压保护': 'exportDischargeUnderVoltage',
            '充电过流保护': 'exportChargeOverCurrent',
            '放电过流保护': 'exportDischargeOverCurrent',
            '过温保护': 'exportOverTemp',
            '低温保护': 'exportUnderTemp',
            '电表设备ID': 'exportMeterId',
            '电表类型': 'exportMeterType',
            'A相电压 (V)': 'exportVoltageA',
            'B相电压 (V)': 'exportVoltageB',
            'C相电压 (V)': 'exportVoltageC',
            'AB线电压 (V)': 'exportVoltageAB',
            'BC线电压 (V)': 'exportVoltageBC',
            'CA线电压 (V)': 'exportVoltageCA',
            'A相电流 (A)': 'exportCurrentA',
            'B相电流 (A)': 'exportCurrentB',
            'C相电流 (A)': 'exportCurrentC',
            '零线电流 (A)': 'exportCurrentN',
            '总有功功率 (kW)': 'exportTotalActivePower',
            '总无功功率 (kVar)': 'exportTotalReactivePower',
            '总视在功率 (kVA)': 'exportTotalApparentPower',
            'A相有功功率 (kW)': 'exportActivePowerA',
            'B相有功功率 (kW)': 'exportActivePowerB',
            'C相有功功率 (kW)': 'exportActivePowerC',
            '正向有功总电能 (kWh)': 'exportPositiveActiveEnergy',
            '反向有功总电能 (kWh)': 'exportReverseActiveEnergy',
            '正向无功总电能 (kVarh)': 'exportPositiveReactiveEnergy',
            '反向无功总电能 (kVarh)': 'exportReverseReactiveEnergy',
            '总功率因数': 'exportTotalPowerFactor',
            'A相功率因数': 'exportPowerFactorA',
            'B相功率因数': 'exportPowerFactorB',
            'C相功率因数': 'exportPowerFactorC',
            '电压不平衡度 (%)': 'exportVoltageUnbalance',
            '电流不平衡度 (%)': 'exportCurrentUnbalance',
            '热管理系统ID': 'exportThermalSystemId',
            '热管理状态': 'exportThermalStatus',
            '室外温度 (°C)': 'exportOutdoorTemp',
            '柜内温度 (°C)': 'exportIndoorTemp',
            '进风口温度 (°C)': 'exportCabinetInletTemp',
            '出风口温度 (°C)': 'exportCabinetOutletTemp',
            '电池最高温度 (°C)': 'exportBatteryMaxTemp',
            '电池最低温度 (°C)': 'exportBatteryMinTemp',
            '电池平均温度 (°C)': 'exportBatteryAvgTemp',
            '电池温差 (°C)': 'exportBatteryTempDiff',
            '制冷模式': 'exportCoolingMode',
            '制冷状态': 'exportCoolingStatus',
            '制冷功率 (kW)': 'exportCoolingPower',
            '压缩机状态': 'exportCompressorStatus',
            '冷媒压力 (MPa)': 'exportRefrigerantPressure',
            '加热模式': 'exportHeatingMode',
            '加热状态': 'exportHeatingStatus',
            '加热功率 (kW)': 'exportHeatingPower',
            '加热器温度 (°C)': 'exportHeaterTemp',
            '风机状态': 'exportFanStatus',
            '风机转速 (rpm)': 'exportFanSpeed',
            '风机功率 (W)': 'exportFanPower',
            '风量 (m³/h)': 'exportAirFlowRate',
            '液冷状态': 'exportLiquidCoolingStatus',
            '冷却液温度 (°C)': 'exportCoolantTemp',
            '冷却液流量 (L/min)': 'exportCoolantFlowRate',
            '冷却液压力 (kPa)': 'exportCoolantPressure',
            '热管理总功率 (kW)': 'exportTotalThermalPower',
            '热管理能耗 (kWh)': 'exportThermalEnergyConsumption',
            '热管理效率 (%)': 'exportThermalEfficiency',
            '消防系统ID': 'exportFireSystemId',
            '系统运行状态': 'exportFireSystemStatus',
            '自检状态': 'exportSelfCheckStatus',
            '1号烟感探测器': 'exportSmokeDetector1',
            '2号烟感探测器': 'exportSmokeDetector2',
            '3号烟感探测器': 'exportSmokeDetector3',
            '烟雾浓度 (ppm)': 'exportSmokeConcentration',
            '1号温感探测器 (°C)': 'exportTempDetector1',
            '2号温感探测器 (°C)': 'exportTempDetector2',
            '3号温感探测器 (°C)': 'exportTempDetector3',
            '温升速率 (°C/min)': 'exportTempRiseRate',
            'H₂浓度 (ppm)': 'exportH2Concentration',
            'CO浓度 (ppm)': 'exportCoConcentration',
            'CO₂浓度 (ppm)': 'exportCo2Concentration',
            '气体告警等级': 'exportGasAlarmLevel',
            '火灾报警状态': 'exportFireAlarmStatus',
            '告警级别': 'exportAlarmLevel',
            '告警类型': 'exportAlarmType',
            '告警位置': 'exportAlarmPosition',
            '灭火模式': 'exportExtinguishingMode',
            '喷淋状态': 'exportSprayStatus',
            '气体灭火状态': 'exportGasExtinguisherStatus',
            '灭火剂压力 (MPa)': 'exportExtinguisherPressure',
            '灭火剂重量 (kg)': 'exportExtinguisherWeight',
            '喷头状态': 'exportNozzleStatus',
            '紧急停机': 'exportEmergencyStop',
            '电源切断': 'exportPowerCutoff',
            '通风系统状态': 'exportVentilationStatus',
            '门禁状态': 'exportDoorLockStatus',
            // 兼容旧的指标ID
            '运行状态': 'exportSystemStatus',
            '电压 (V)': 'exportBatteryVoltage',
            '电流 (A)': 'exportBatteryCurrent',
            '功率 (kW)': 'exportActivePower',
            '温度 (°C)': 'exportBatteryTemp',
            '日充电量 (kWh)': 'exportTodayCharge',
            '日放电量 (kWh)': 'exportTodayDischarge',
            '告警数量': 'exportAlarmCount'
        };

        // 获取翻译后的分组名称
        function getTranslatedGroupName(groupName) {
            const key = groupNameTranslations[groupName];
            if (key && typeof getTranslation === 'function') {
                return getTranslation(key);
            }
            return groupName;
        }

        // 获取翻译后的指标标签
        function getTranslatedLabel(label) {
            const key = indicatorLabelTranslations[label];
            if (key && typeof getTranslation === 'function') {
                return getTranslation(key);
            }
            return label;
        }

        // ==================== 初始化 ====================
        document.addEventListener('DOMContentLoaded', function() {
            initComponent(); // 初始化组件选择
            initDatePickers();
            renderIndicatorGroups();
            updateSelectionCount();

            // 监听语言切换事件
            window.addEventListener('languageChanged', function() {
                renderIndicatorGroups();
                updateDatePickerLocale();
            });
        });

        // 初始化组件选择（从URL参数读取）
        function initComponent() {
            const urlParams = new URLSearchParams(window.location.search);
            const componentParam = urlParams.get('component');

            // 如果URL中有component参数，则使用该参数
            if (componentParam && componentIndicatorConfigs[componentParam]) {
                currentComponent = componentParam;
                document.getElementById('componentSelect').value = componentParam;
            }
        }

        // 初始化日期选择器
        function initDatePickers() {
            const now = new Date();
            const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

            startDatePicker = flatpickr("#startDate", {
                locale: flatpickr.l10ns.zh,
                enableTime: true,
                dateFormat: "Y-m-d H:i",
                defaultDate: sevenDaysAgo,
                time_24hr: true,
                maxDate: now
            });

            endDatePicker = flatpickr("#endDate", {
                locale: flatpickr.l10ns.zh,
                enableTime: true,
                dateFormat: "Y-m-d H:i",
                defaultDate: now,
                time_24hr: true,
                maxDate: now
            });
        }

        // 更新日期选择器的语言
        function updateDatePickerLocale() {
            const currentLang = localStorage.getItem('language') || 'zh';
            const locale = currentLang === 'zh' ? flatpickr.l10ns.zh : flatpickr.l10ns.default;

            if (startDatePicker) {
                startDatePicker.set('locale', locale);
                startDatePicker.redraw();
            }
            if (endDatePicker) {
                endDatePicker.set('locale', locale);
                endDatePicker.redraw();
            }
        }

        // 处理组件切换
        function handleComponentChange() {
            const select = document.getElementById('componentSelect');
            currentComponent = select.value;

            // 清空当前选择
            selectedIndicators.clear();

            // 重新渲染指标组
            renderIndicatorGroups();
            updateSelectionCount();

            // 隐藏数据表格
            document.getElementById('dataTableContainer').classList.remove('show');
        }

        // 渲染指标组
        function renderIndicatorGroups() {
            const container = document.getElementById('indicatorGroups');
            container.innerHTML = '';

            // 获取当前组件的指标配置
            const indicatorConfig = componentIndicatorConfigs[currentComponent];
            if (!indicatorConfig) {
                console.error('未找到组件配置:', currentComponent);
                return;
            }

            // 获取全选按钮翻译
            const selectAllText = typeof getTranslation === 'function' ? getTranslation('selectAll') || '全选' : '全选';

            Object.entries(indicatorConfig).forEach(([groupName, indicators]) => {
                // 获取翻译后的分组名称和指标标签
                const translatedGroupName = getTranslatedGroupName(groupName);

                const groupHtml = `
                    <div class="indicator-group">
                        <div class="group-header" onclick="toggleGroup(this)">
                            <div class="group-title">
                                <i class="fas fa-folder"></i>
                                <span>${translatedGroupName}</span>
                            </div>
                            <div class="group-actions">
                                <span class="select-all-btn" onclick="selectAllInGroup(event, '${groupName}')">${selectAllText}</span>
                                <i class="fas fa-chevron-down expand-icon"></i>
                            </div>
                        </div>
                        <div class="group-content" id="group-${groupName}">
                            ${indicators.map(ind => `
                                <div class="checkbox-item">
                                    <input type="checkbox"
                                           id="${ind.id}"
                                           ${ind.checked ? 'checked' : ''}
                                           onchange="handleCheckboxChange('${ind.id}')">
                                    <label for="${ind.id}">${getTranslatedLabel(ind.label)}</label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                container.innerHTML += groupHtml;

                // 初始化选中的指标
                indicators.forEach(ind => {
                    if (ind.checked) {
                        selectedIndicators.add(ind.id);
                    }
                });
            });
        }

        // 切换分组展开/折叠
        function toggleGroup(header) {
            if (event.target.closest('.select-all-btn')) return;

            header.classList.toggle('collapsed');
            const content = header.nextElementSibling;
            content.classList.toggle('collapsed');
        }

        // 全选分组
        function selectAllInGroup(event, groupName) {
            event.stopPropagation();
            const group = document.getElementById(`group-${groupName}`);
            const checkboxes = group.querySelectorAll('input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);

            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
                if (!allChecked) {
                    selectedIndicators.add(checkbox.id);
                } else {
                    selectedIndicators.delete(checkbox.id);
                }
            });

            updateSelectionCount();
        }

        // 复选框变化处理
        function handleCheckboxChange(id) {
            const checkbox = document.getElementById(id);
            if (checkbox.checked) {
                selectedIndicators.add(id);
            } else {
                selectedIndicators.delete(id);
            }
            updateSelectionCount();
        }

        // 更新选择计数
        function updateSelectionCount() {
            const count = selectedIndicators.size;
            document.getElementById('selectionCount').textContent = count;
            document.getElementById('queryBtn').disabled = count === 0;
        }

        // 重置选择
        function resetSelection() {
            selectedIndicators.clear();
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            updateSelectionCount();
            // 隐藏数据表格
            document.getElementById('dataTableContainer').classList.remove('show');
            const msg = typeof getTranslation === 'function' ? getTranslation('exportMsgResetDone') : '已重置选择';
            showNotification(msg, 'info');
        }

        // 查询数据
        function handleQuery() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                const msg = typeof getTranslation === 'function' ? getTranslation('exportMsgSelectTimeRange') : '请选择时间范围';
                showNotification(msg, 'warning');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                const msg = typeof getTranslation === 'function' ? getTranslation('exportMsgStartBeforeEnd') : '开始时间不能晚于结束时间';
                showNotification(msg, 'warning');
                return;
            }

            if (selectedIndicators.size === 0) {
                const msg = typeof getTranslation === 'function' ? getTranslation('exportMsgSelectIndicator') : '请至少选择一个查询指标';
                showNotification(msg, 'warning');
                return;
            }

            const loadingMsg = typeof getTranslation === 'function' ? getTranslation('exportLoading') : '正在查询数据...';
            showLoading(loadingMsg);

            // 模拟数据查询
            setTimeout(() => {
                currentData = generateQueryData(startDate, endDate);
                renderDataTable(currentData);
                document.getElementById('dataTableContainer').classList.add('show');
                hideLoading();
                let successMsg = typeof getTranslation === 'function' ? getTranslation('exportMsgQuerySuccess') : '查询成功！共 {count} 条数据';
                successMsg = successMsg.replace('{count}', currentData.length);
                showNotification(successMsg, 'success');

                // 滚动到表格位置
                document.getElementById('dataTableContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 1000);
        }

        // 生成查询数据
        function generateQueryData(startDate, endDate) {
            const data = [];
            const start = new Date(startDate);
            const end = new Date(endDate);

            // 获取用户选择的颗粒度（分钟）
            const intervalMinutes = parseInt(document.getElementById('intervalSelect').value) || 5;
            const interval = intervalMinutes * 60 * 1000; // 转换为毫秒

            // 基础累计值（模拟递增）
            let baseChargeEnergy = 1250.5;
            let baseDischargeEnergy = 1180.3;
            let baseTodayCharge = 0;
            let baseTodayDischarge = 0;
            let lastDate = start.toDateString();

            for (let time = start.getTime(); time <= end.getTime(); time += interval) {
                const row = {};
                const timestamp = new Date(time);

                // 检测日期变化，重置日统计
                if (timestamp.toDateString() !== lastDate) {
                    baseTodayCharge = 0;
                    baseTodayDischarge = 0;
                    lastDate = timestamp.toDateString();
                }

                // 模拟运行状态（基于时间段）
                const hour = timestamp.getHours();
                let isCharging = (hour >= 0 && hour < 7) || (hour >= 12 && hour < 14); // 谷电时段充电
                let isDischarging = (hour >= 9 && hour < 12) || (hour >= 18 && hour < 22); // 峰电时段放电
                const systemStatus = isCharging ? '充电' : (isDischarging ? '放电' : '待机');
                const operationModes = ['削峰填谷', '需求响应', '备用电源', '自动模式'];
                const operationMode = operationModes[Math.floor(hour / 6)];

                // 功率计算（基于状态）
                const basePower = isCharging ? (80 + Math.random() * 40) : (isDischarging ? -(60 + Math.random() * 50) : (Math.random() * 5 - 2.5));
                const activePower = basePower;
                const powerFactor = 0.92 + Math.random() * 0.06;
                const apparentPower = Math.abs(activePower) / powerFactor;
                const reactivePower = Math.sqrt(apparentPower * apparentPower - activePower * activePower) * (Math.random() > 0.5 ? 1 : -1);

                // 累计能量（基于实际选择的颗粒度计算）
                if (isCharging) {
                    const chargeIncrement = Math.abs(activePower) * (intervalMinutes / 60); // 按颗粒度计算能量
                    baseTodayCharge += chargeIncrement;
                    baseChargeEnergy += chargeIncrement / 1000;
                } else if (isDischarging) {
                    const dischargeIncrement = Math.abs(activePower) * (intervalMinutes / 60);
                    baseTodayDischarge += dischargeIncrement;
                    baseDischargeEnergy += dischargeIncrement / 1000;
                }

                selectedIndicators.forEach(id => {
                    switch(id) {
                        // ==================== 整机 - 基础信息 ====================
                        case 'timestamp':
                            row[getTranslatedLabel('时间戳')] = formatDateTime(timestamp);
                            break;
                        case 'cabinetId':
                            row[getTranslatedLabel('储能柜ID')] = 'ESS-001';
                            break;
                        case 'systemStatus':
                            row[getTranslatedLabel('系统状态')] = systemStatus;
                            break;
                        case 'operationMode':
                            row[getTranslatedLabel('运行模式')] = operationMode;
                            break;

                        // ==================== 整机 - 功率数据 ====================
                        case 'activePower':
                            row[getTranslatedLabel('有功功率 (kW)')] = activePower.toFixed(2);
                            break;
                        case 'reactivePower':
                            row[getTranslatedLabel('无功功率 (kVar)')] = reactivePower.toFixed(2);
                            break;
                        case 'apparentPower':
                            row[getTranslatedLabel('视在功率 (kVA)')] = apparentPower.toFixed(2);
                            break;
                        case 'powerFactor':
                            row[getTranslatedLabel('功率因数')] = powerFactor.toFixed(3);
                            break;

                        // ==================== 整机 - 电池状态 ====================
                        case 'soc':
                            // SOC 根据充放电状态变化
                            const baseSOC = 50 + Math.sin(time / (3600 * 1000) * Math.PI / 12) * 30;
                            row[getTranslatedLabel('SOC (%)')] = Math.max(10, Math.min(95, baseSOC + Math.random() * 5)).toFixed(1);
                            break;
                        case 'soh':
                            row[getTranslatedLabel('SOH (%)')] = (96.5 + Math.random() * 2).toFixed(1);
                            break;
                        case 'batteryVoltage':
                            row[getTranslatedLabel('电池电压 (V)')] = (380 + Math.random() * 20).toFixed(1);
                            break;
                        case 'batteryCurrent':
                            const batteryCurrent = isCharging ? (180 + Math.random() * 40) : (isDischarging ? -(150 + Math.random() * 50) : (Math.random() * 5 - 2.5));
                            row[getTranslatedLabel('电池电流 (A)')] = batteryCurrent.toFixed(1);
                            break;
                        case 'batteryTemp':
                            row[getTranslatedLabel('电池温度 (°C)')] = (25 + Math.random() * 8).toFixed(1);
                            break;

                        // ==================== 整机 - 能量统计 ====================
                        case 'todayCharge':
                            row[getTranslatedLabel('今日充电量 (kWh)')] = baseTodayCharge.toFixed(2);
                            break;
                        case 'todayDischarge':
                            row[getTranslatedLabel('今日放电量 (kWh)')] = baseTodayDischarge.toFixed(2);
                            break;
                        case 'totalChargeEnergy':
                            row[getTranslatedLabel('累计充电量 (MWh)')] = baseChargeEnergy.toFixed(3);
                            break;
                        case 'totalDischargeEnergy':
                            row[getTranslatedLabel('累计放电量 (MWh)')] = baseDischargeEnergy.toFixed(3);
                            break;

                        // ==================== 兼容旧的指标ID ====================
                        case 'status':
                            row[getTranslatedLabel('运行状态')] = systemStatus;
                            break;
                        case 'voltage':
                            row[getTranslatedLabel('电压 (V)')] = (380 + Math.random() * 20).toFixed(1);
                            break;
                        case 'current':
                            row[getTranslatedLabel('电流 (A)')] = (Math.random() * 50 - 25).toFixed(1);
                            break;
                        case 'power':
                            row[getTranslatedLabel('功率 (kW)')] = activePower.toFixed(2);
                            break;
                        case 'temperature':
                            row[getTranslatedLabel('温度 (°C)')] = (25 + Math.random() * 8).toFixed(1);
                            break;
                        case 'dailyCharge':
                            row[getTranslatedLabel('日充电量 (kWh)')] = baseTodayCharge.toFixed(2);
                            break;
                        case 'dailyDischarge':
                            row[getTranslatedLabel('日放电量 (kWh)')] = baseTodayDischarge.toFixed(2);
                            break;
                        case 'totalCharge':
                            row[getTranslatedLabel('累计充电量 (MWh)')] = baseChargeEnergy.toFixed(3);
                            break;
                        case 'totalDischarge':
                            row[getTranslatedLabel('累计放电量 (MWh)')] = baseDischargeEnergy.toFixed(3);
                            break;
                        case 'packCount':
                            row[getTranslatedLabel('Pack簇数量')] = '4';
                            break;
                        case 'pack1Voltage':
                            row[getTranslatedLabel('Pack1电压 (V)')] = (95 + Math.random() * 5).toFixed(1);
                            break;
                        case 'pack1Current':
                            row[getTranslatedLabel('Pack1电流 (A)')] = (40 + Math.random() * 15).toFixed(1);
                            break;
                        case 'pack1Soc':
                            row[getTranslatedLabel('Pack1 SOC (%)')] = (80 + Math.random() * 15).toFixed(1);
                            break;
                        case 'pack1Temp':
                            row[getTranslatedLabel('Pack1最高温度 (°C)')] = (26 + Math.random() * 6).toFixed(1);
                            break;
                        case 'alarmCount':
                            row[getTranslatedLabel('告警数量')] = Math.floor(Math.random() * 3);
                            break;
                        case 'alarmLevel':
                            const levels = ['正常', '警告', '严重'];
                            row[getTranslatedLabel('告警级别')] = levels[Math.floor(Math.random() * levels.length)];
                            break;
                        case 'alarmType':
                            const types = ['无', '温度告警', '电压告警', '通信告警'];
                            row[getTranslatedLabel('告警类型')] = types[Math.floor(Math.random() * types.length)];
                            break;
                    }
                });

                data.push(row);
            }

            return data;
        }

        // 渲染数据表格
        function renderDataTable(data) {
            if (data.length === 0) {
                document.getElementById('tableHead').innerHTML = '';
                document.getElementById('tableBody').innerHTML = `
                    <tr>
                        <td colspan="100%" style="text-align: center; padding: 60px 20px;">
                            <div class="empty-data">
                                <i class="fas fa-inbox"></i>
                                <div class="empty-data-text">${typeof getTranslation === 'function' ? getTranslation('exportNoData') : '暂无数据'}</div>
                                <div class="empty-data-hint">${typeof getTranslation === 'function' ? getTranslation('exportNoDataDesc') : '请先选择时间范围和指标进行查询'}</div>
                            </div>
                        </td>
                    </tr>
                `;
                updateDataCount(0);
                return;
            }

            // 渲染表头
            const headers = Object.keys(data[0]);
            const theadHtml = '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
            document.getElementById('tableHead').innerHTML = theadHtml;

            // 渲染表格数据
            const tbodyHtml = data.map(row => {
                return '<tr>' + headers.map(h => `<td>${row[h]}</td>`).join('') + '</tr>';
            }).join('');
            document.getElementById('tableBody').innerHTML = tbodyHtml;

            // 更新数据计数
            updateDataCount(data.length);
        }

        // 更新数据计数显示
        function updateDataCount(count) {
            const totalText = typeof getTranslation === 'function' ? getTranslation('exportTotalData') : '共';
            const unitText = typeof getTranslation === 'function' ? getTranslation('exportDataUnit') : '条数据';
            document.getElementById('dataCount').innerHTML = `<span id="exportTotalData">${totalText}</span> ${count} <span id="exportDataUnit">${unitText}</span>`;
        }

        // 导出数据
        function handleExport() {
            if (currentData.length === 0) {
                const msg = typeof getTranslation === 'function' ? getTranslation('exportMsgNoDataToExport') : '暂无数据可导出';
                showNotification(msg, 'warning');
                return;
            }

            const loadingMsg = typeof getTranslation === 'function' ? getTranslation('exportLoadingExport') : '正在导出数据...';
            showLoading(loadingMsg);

            setTimeout(() => {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                exportToCSV(currentData, startDate, endDate);
                hideLoading();
                let successMsg = typeof getTranslation === 'function' ? getTranslation('exportMsgExportSuccess') : '成功导出 {count} 条数据！';
                successMsg = successMsg.replace('{count}', currentData.length);
                showNotification(successMsg, 'success');
            }, 500);
        }

        // 导出为CSV
        function exportToCSV(data, startDate, endDate) {
            if (data.length === 0) return;

            const headers = Object.keys(data[0]);
            let csvContent = '\ufeff' + headers.join(',') + '\n';

            data.forEach(row => {
                const values = headers.map(header => {
                    const value = row[header];
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                        return '"' + value.replace(/"/g, '""') + '"';
                    }
                    return value;
                });
                csvContent += values.join(',') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const filename = `数据导出_${formatDateForFilename(new Date(startDate))}_${formatDateForFilename(new Date(endDate))}.csv`;

            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 返回上一页
        function goBack() {
            window.history.back();
        }

        // ==================== 工具函数 ====================

        function showLoading(text) {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;

            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                info: 'fa-info-circle',
                warning: 'fa-exclamation-triangle'
            };

            const colors = {
                success: '#4caf50',
                error: '#f44336',
                info: '#2196f3',
                warning: '#ff9800'
            };

            notification.innerHTML = `
                <i class="fas ${icons[type]}" style="color: ${colors[type]}; font-size: 20px;"></i>
                <span>${message}</span>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function formatDateTime(date) {
            return date.getFullYear() + '-' +
                   String(date.getMonth() + 1).padStart(2, '0') + '-' +
                   String(date.getDate()).padStart(2, '0') + ' ' +
                   String(date.getHours()).padStart(2, '0') + ':' +
                   String(date.getMinutes()).padStart(2, '0') + ':' +
                   String(date.getSeconds()).padStart(2, '0');
        }

        function formatDateForFilename(date) {
            return date.getFullYear() +
                   String(date.getMonth() + 1).padStart(2, '0') +
                   String(date.getDate()).padStart(2, '0') + '_' +
                   String(date.getHours()).padStart(2, '0') +
                   String(date.getMinutes()).padStart(2, '0');
        }
    </script>
</body>
</html>
